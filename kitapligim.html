<!DOCTYPE html>
<html lang="tr" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benim Güzel Kütüphanem</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Zilla+Slab:wght@400;700&family=Roboto+Mono:wght@400&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* TASARIM UZMANI DOKUNUŞLARI - SÜRÜM 12.0 (KRİTİK HATA DÜZELTMESİ) */
        :root {
            --font-heading: 'Zilla Slab', serif;
            --font-body: 'Poppins', sans-serif;
            --font-mono: 'Roboto Mono', monospace;
            --font-serif: 'Merriweather', serif;
            --border-radius-sm: 8px; --border-radius-md: 12px; --border-radius-lg: 16px;
            --shadow-sm: 0 2px 8px rgba(45, 55, 72, 0.07);
            --shadow-md: 0 6px 20px rgba(45, 55, 72, 0.08);
            --shadow-lg: 0 10px 30px rgba(45, 55, 72, 0.1);
            --transition-speed: 0.3s;
        }

        /* --- TEMA PALETLERİ --- */
        [data-theme="light"] { --bg-color: #f4f7f9; --bg-color-alt: #e9eef2; --card-bg: #ffffff; --primary-text: #2d3748; --secondary-text: #718096; --border-color: #e2e8f0; --accent-1: #ff6347; --accent-2: #00b894; --accent-3: #ffc107; --success-color: #2ecc71; --danger-color: #e74c3c; --font-override: var(--font-body); }
        [data-theme="sepia"] { --bg-color: #f1e7d0; --bg-color-alt: #e3d9c3; --card-bg: #fdfaf3; --primary-text: #5d4037; --secondary-text: #8d6e63; --border-color: #d7ccc8; --accent-1: #d96d51; --accent-2: #5a9b7e; --accent-3: #c5a148; --success-color: #689f38; --danger-color: #d32f2f; --font-override: var(--font-body); }
        [data-theme="nane-sekeri"] { --bg-color: #f0fff4; --bg-color-alt: #e0f8e9; --card-bg: #ffffff; --primary-text: #2f4f4f; --secondary-text: #5f8075; --border-color: #cce8d6; --accent-1: #50c878; --accent-2: #3cb371; --accent-3: #f5b041; --success-color: #2ecc71; --danger-color: #ff6b6b; --font-override: var(--font-body); }
        [data-theme="lavanta-tarlasi"] { --bg-color: #f3f0ff; --bg-color-alt: #e9e3ff; --card-bg: #ffffff; --primary-text: #4a4a68; --secondary-text: #7b7ba3; --border-color: #d9d2f7; --accent-1: #9d84e1; --accent-2: #a17de0; --accent-3: #f9a825; --success-color: #7dcea0; --danger-color: #ef9a9a; --font-override: var(--font-body); }
        [data-theme="vanilya-damlasi"] { --bg-color: #fdfcf7; --bg-color-alt: #f8f4e9; --card-bg: #ffffff; --primary-text: #5a4e46; --secondary-text: #918177; --border-color: #e9e2d9; --accent-1: #d2a679; --accent-2: #a89f91; --accent-3: #e5b36f; --success-color: #a1c349; --danger-color: #d87068; --font-override: var(--font-body); }
        [data-theme="somon-ruyasi"] { --bg-color: #fff5f5; --bg-color-alt: #ffe9e9; --card-bg: #ffffff; --primary-text: #6b4a4a; --secondary-text: #a17d7d; --border-color: #f7dada; --accent-1: #ff8c69; --accent-2: #f08080; --accent-3: #f8c471; --success-color: #6bca88; --danger-color: #e57373; --font-override: var(--font-body); }
        [data-theme="gazete-kagidi"] { --bg-color: #f5f2e8; --bg-color-alt: #e8e4d9; --card-bg: #fffbf0; --primary-text: #1a1a1a; --secondary-text: #595959; --border-color: #d1cdc0; --accent-1: #d92121; --accent-2: #333333; --accent-3: #b08d57; --success-color: #006400; --danger-color: #d92121; --font-override: var(--font-serif); }
        [data-theme="okyanus-esintisi"] { --bg-color: #e0f7fa; --bg-color-alt: #b2ebf2; --card-bg: #ffffff; --primary-text: #006064; --secondary-text: #00838f; --border-color: #80deea; --accent-1: #00acc1; --accent-2: #26c6da; --accent-3: #ffc107; --success-color: #80cbc4; --danger-color: #ff8a80; --font-override: var(--font-body); }
        [data-theme="dark"] { --bg-color: #1a202c; --bg-color-alt: #2d3748; --card-bg: #2d3748; --primary-text: #f7fafc; --secondary-text: #a0aec0; --border-color: #4a5568; --accent-1: #f56565; --accent-2: #48bb78; --accent-3: #f6e05e; --success-color: #48bb78; --danger-color: #f56565; --font-override: var(--font-body); }
        [data-theme="gece-mavisi"] { --bg-color: #0d1b2a; --bg-color-alt: #1b263b; --card-bg: #1b263b; --primary-text: #e0e1dd; --secondary-text: #778da9; --border-color: #415a77; --accent-1: #3a86ff; --accent-2: #06d6a0; --accent-3: #ffd166; --success-color: #06d6a0; --danger-color: #ef476f; --font-override: var(--font-body); }
        [data-theme="grafit-gecesi"] { --bg-color: #121212; --bg-color-alt: #1e1e1e; --card-bg: #1e1e1e; --primary-text: #ffffff; --secondary-text: #b3b3b3; --border-color: #282828; --accent-1: #bb86fc; --accent-2: #03dac6; --accent-3: #f9a825; --success-color: #03dac6; --danger-color: #cf6679; --font-override: var(--font-body); }
        [data-theme="zumrut-derinligi"] { --bg-color: #0b2027; --bg-color-alt: #103039; --card-bg: #103039; --primary-text: #f4f4f4; --secondary-text: #a4c3b2; --border-color: #1e4550; --accent-1: #69b578; --accent-2: #4e8789; --accent-3: #e5b36f; --success-color: #69b578; --danger-color: #d64933; --font-override: var(--font-body); }
        [data-theme="yakut-kirmizisi"] { --bg-color: #23001e; --bg-color-alt: #3d0024; --card-bg: #3d0024; --primary-text: #fce5f2; --secondary-text: #d8a1c4; --border-color: #5c0036; --accent-1: #e01e5a; --accent-2: #c44569; --accent-3: #ffc40c; --success-color: #79c753; --danger-color: #e01e5a; --font-override: var(--font-body); }
        [data-theme="retro-terminal"] { --bg-color: #000000; --bg-color-alt: #111111; --card-bg: #090909; --primary-text: #39ff14; --secondary-text: #17a400; --border-color: #222; --accent-1: #39ff14; --accent-2: #39ff14; --accent-3: #39ff14; --success-color: #39ff14; --danger-color: #ff073a; --font-override: var(--font-mono); }
        [data-theme="gunes-batimi"] { --bg-color: #2c0e37; --bg-color-alt: #431752; --card-bg: #431752; --primary-text: #fdeaff; --secondary-text: #d8b4e4; --border-color: #6d2f84; --accent-1: #ff5733; --accent-2: #f9a825; --accent-3: #f5d491; --success-color: #90ee90; --danger-color: #ff5733; --font-override: var(--font-body); }
        [data-theme="sade-beton"] { --bg-color: #e9ecef; --bg-color-alt: #ced4da; --card-bg: #f8f9fa; --primary-text: #212529; --secondary-text: #6c757d; --border-color: #dee2e6; --accent-1: #007bff; --accent-2: #6c757d; --accent-3: #ffc107; --success-color: #28a745; --danger-color: #dc3545; --font-override: var(--font-body); }
        
        /* --- GENEL STİLLER --- */
        *, *::before, *::after { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-override, var(--font-body)); margin: 0; background-color: var(--bg-color); color: var(--primary-text); font-size: 16px; line-height: 1.6; transition: background-color var(--transition-speed), color var(--transition-speed); }
        .container { max-width: 1200px; margin: 20px auto; padding: 15px; }
        h1, h2, h3, h4 { font-family: var(--font-heading); margin-top: 0; color: var(--primary-text); font-weight: 700; }
        header { text-align: center; padding: 1rem; margin-bottom: 20px; }
        header h1 { font-size: 3.5em; margin: 0; }
        .controls-bar { padding: 25px; background-color: var(--card-bg); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-md); display: flex; flex-wrap: wrap; align-items: center; gap: 15px; margin-bottom: 30px; border: 1px solid var(--border-color); }
        .controls-bar input[type="text"] { flex-grow: 1; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); background-color: var(--bg-color); min-width: 200px; color: var(--primary-text); }
        .controls-bar input[type="text"]:focus { outline: none; border-color: var(--accent-1); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-1) 20%, transparent); }
        .control-group { display: flex; gap: 10px; flex-wrap: wrap; }
        button, .btn { background-color: var(--accent-1); color: white; padding: 10px 20px; border: none; border-radius: var(--border-radius-md); cursor: pointer; font-size: 1em; font-weight: 600; letter-spacing: 0.5px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; transition: all 0.2s ease-in-out; }
        button:hover, .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-sm); }
        button:disabled { background-color: #ccc; color: #666; cursor: not-allowed; transform: translateY(0); box-shadow: none; }
        .btn-primary { background-color: var(--accent-1); } .btn-primary:hover { background-color: color-mix(in srgb, var(--accent-1) 85%, black); }
        .btn-secondary { background-color: var(--accent-2); } .btn-secondary:hover { background-color: color-mix(in srgb, var(--accent-2) 85%, black); }
        .btn-danger { background-color: var(--danger-color); } .btn-danger:hover { background-color: color-mix(in srgb, var(--danger-color) 85%, black); }
        .btn-subtle { background-color: var(--bg-color-alt); color: var(--primary-text); } .btn-subtle:hover { background-color: var(--border-color); }
        .icon-btn { background: none; padding: 8px; border-radius: 50%; width: 44px; height: 44px; }
        .icon-btn svg { width: 24px; height: 24px; fill: var(--secondary-text); transition: fill 0.2s; } .icon-btn:hover svg { fill: var(--primary-text); }
        
        .list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .book-card { background-color: var(--card-bg); border-radius: var(--border-radius-md); box-shadow: var(--shadow-sm); overflow: hidden; display: flex; cursor: pointer; border: 1px solid var(--border-color); transition: all var(--transition-speed) ease-in-out; }
        .book-card:hover { transform: translateY(-6px); box-shadow: var(--shadow-md); }
        .card-cover img { width: 110px; height: 165px; object-fit: cover; display: block; background-color: var(--bg-color-alt); }
        .card-info { padding: 20px; display: flex; flex-direction: column; justify-content: center; flex-grow: 1; overflow: hidden; }

        /* --- YENİ MODAL TASARIMI --- */
        .modal { display: flex; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: color-mix(in srgb, var(--bg-color) 60%, transparent); backdrop-filter: blur(8px); animation: fadeIn 0.3s; padding: 5vh 15px; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--card-bg); border-radius: var(--border-radius-lg); width: 90%; max-width: 800px; position: relative; box-shadow: var(--shadow-lg); animation: slideIn 0.3s; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { padding: 25px 35px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-header h2 { margin: 0; font-size: 1.8em; }
        .modal-body { padding: 30px 35px; overflow-y: auto; }
        .modal-footer { padding: 20px 35px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; background-color: var(--bg-color-alt); border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg); flex-shrink: 0; }
        .close-button { background: none; border: none; font-size: 2.5em; line-height: 1; cursor: pointer; color: var(--secondary-text); padding: 0 5px; } .close-button:hover { color: var(--primary-text); }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9em; color: var(--secondary-text); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); background-color: var(--bg-color); color: var(--primary-text); font-size: 1em; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent-1); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-1) 20%, transparent); }
        
        .fieldset { border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 20px; margin-bottom: 25px; }
        .fieldset legend { font-family: var(--font-heading); font-weight: 700; color: var(--secondary-text); padding: 0 10px; margin-left: 10px; }
        
        #api-results { position: absolute; background: var(--card-bg); width: 100%; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 var(--border-radius-md) var(--border-radius-md); z-index: 10; max-height: 250px; overflow-y: auto; box-shadow: var(--shadow-md); }
        .api-result-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .theme-switcher { display: flex; gap: 10px; flex-wrap: wrap; }
        .theme-btn { padding: 10px 15px; border: 2px solid var(--border-color); background-color: var(--bg-color); color: var(--primary-text); font-weight: 600; cursor: pointer; border-radius: var(--border-radius-md); font-size: 0.9em; }
        .theme-btn.active { border-color: var(--accent-1); color: var(--accent-1); }
        
        .details-grid { display: grid; grid-template-columns: 200px 1fr; gap: 30px; align-items: flex-start; }
        @media (max-width: 768px) { .details-grid { grid-template-columns: 1fr; } }
        .details-cover img { width: 100%; height: auto; border-radius: var(--border-radius-md); box-shadow: var(--shadow-md); background-color: var(--bg-color-alt); }
        .details-info-grid { display: grid; grid-template-columns: auto 1fr; gap: 10px 15px; align-items: center; margin-bottom: 20px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; text-align: center; }
        .stat-card { background-color: var(--bg-color-alt); padding: 25px 20px; border-radius: var(--border-radius-lg); }
        
        #discovery-results-list { max-height: 50vh; overflow-y: auto; margin-top: 20px; border-top: 1px solid var(--border-color); }
        .discovery-item { display: flex; gap: 15px; align-items: center; padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .discovery-item:hover { background-color: var(--bg-color-alt); }
        
        /* --- YENİ: ÖZEL NOTLAR MODÜLÜ STİLLERİ --- */
        #private-notes-list { max-height: 60vh; overflow-y: auto; }
        .private-note-item { padding: 20px; background-color: var(--bg-color-alt); border-radius: var(--border-radius-md); margin-bottom: 15px; cursor: pointer; transition: background-color 0.2s; }
        .private-note-item:hover { background-color: var(--border-color); }
        .private-note-item p { margin: 0 0 10px 0; white-space: pre-wrap; /* Satır sonlarını korur */ }
        .private-note-item small { color: var(--secondary-text); }

        .hidden { display: none; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes slideIn { from {transform: translateY(20px) scale(0.98); opacity: 0;} to {transform: translateY(0) scale(1); opacity: 1;} }
    </style>
</head>
<body>

    <div id="login-screen" style="text-align: center; padding-top: 20vh;">
        <header><h1>Benim Güzel Kütüphanem</h1></header>
        <button id="login-btn" class="btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="white"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/><path d="M1 1h22v22H1z" fill="none"/></svg>
            Google ile Giriş Yap
        </button>
    </div>

    <div id="main-app" class="hidden">
        <header>
            <h1>Benim Güzel Kütüphanem</h1>
            <div class="user-profile" style="font-weight: 600; display: flex; align-items: center; justify-content: center;">
                <span id="user-display-name"></span>
                <button id="logout-btn" class="btn-subtle" style="margin-left:15px; font-size:0.8em; padding:8px 12px;">Çıkış Yap</button>
            </div>
        </header>
        <div class="container">
            <main id="library-view">
                <div class="controls-bar">
                    <button id="add-book-btn" class="btn-primary">Yeni Kitap Ekle</button>
                    <button id="discover-books-btn" class="btn-secondary">Kitap Keşfet</button>
                    <button id="private-notes-btn" class="btn-subtle">Özel Notlar</button>
                    <input type="text" id="search-input" placeholder="Kütüphanede ara...">
                    <div class="control-group">
                        <select id="filter-status" class="btn btn-subtle" style="padding: 12px;">
                            <option value="Tümü">Filtrele: Tümü</option><option value="Okunacak">Okunacak</option><option value="Okunuyor">Okunuyor</option><option value="Okundu">Okundu</option><option value="Ödünç Verildi">Ödünç Verildi</option>
                        </select>
                        <select id="sort-by" class="btn btn-subtle" style="padding: 12px;">
                            <option value="title_asc" selected>Sırala: Ada Göre (A-Z)</option>
                            <option value="dateAdded_desc">Sırala: Eklenme Tarihi (Yeni)</option>
                        </select>
                    </div>
                     <button id="settings-btn" class="icon-btn" title="Ayarlar">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24-.42-.12.64l2 3.46c.12.22.39.3.61-.22l2.49-1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                    </button>
                </div>
                <div class="list-container" id="book-list"></div>
            </main>
        </div>
        <div id="modal-container"></div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Değişkenler ve Firebase Kurulumu ---
        const firebaseConfig = { 
            apiKey: "AIzaSyASaHGgjR-zsQ50E9JmCcBnBq2KyXcltuE",
            authDomain: "benim-kutuphanem402.firebaseapp.com",
            projectId: "benim-kutuphanem402",
            storageBucket: "benim-kutuphanem402.appspot.com",
            messagingSenderId: "400988696330",
            appId: "1:400988696330:web:d9e2f0fa4301c2c8f714f3"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue;

        let allBooks = [];
        let currentUser = null;
        let unsubscribeBooks = null;

        const ui = {
            loginScreen: document.getElementById('login-screen'), mainApp: document.getElementById('main-app'),
            loginBtn: document.getElementById('login-btn'), logoutBtn: document.getElementById('logout-btn'),
            userDisplayName: document.getElementById('user-display-name'), bookList: document.getElementById('book-list'),
            searchInput: document.getElementById('search-input'), filterStatus: document.getElementById('filter-status'), 
            sortBy: document.getElementById('sort-by'), modalContainer: document.getElementById('modal-container'),
            settingsBtn: document.getElementById('settings-btn'),
            addBookBtn: document.getElementById('add-book-btn'),
            discoverBooksBtn: document.getElementById('discover-books-btn'),
            privateNotesBtn: document.getElementById('private-notes-btn')
        };
        
        const applyTheme = (themeName) => {
            document.documentElement.dataset.theme = themeName;
            localStorage.setItem('libraryTheme', themeName);
        };
        const loadTheme = () => {
            const savedTheme = localStorage.getItem('libraryTheme') || 'light';
            applyTheme(savedTheme);
        };
        loadTheme();

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                ui.loginScreen.classList.add('hidden'); ui.mainApp.classList.remove('hidden');
                ui.userDisplayName.textContent = `Hoş geldin, ${user.displayName.split(' ')[0]}`;
                loadBooks();
            } else {
                currentUser = null;
                ui.loginScreen.classList.remove('hidden'); ui.mainApp.classList.add('hidden');
                if (unsubscribeBooks) unsubscribeBooks();
            }
        });
        ui.loginBtn.onclick = () => { const p = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(p).catch(e => showToast(`Giriş Hatası: ${e.message}`, 'error')); };
        ui.logoutBtn.onclick = () => auth.signOut();

        const getBooksCollection = () => db.collection('users').doc(currentUser.uid).collection('books');
        
        const loadBooks = () => {
            if (unsubscribeBooks) unsubscribeBooks();
            let query = getBooksCollection().orderBy('dateAdded', 'desc');
            unsubscribeBooks = query.onSnapshot(snapshot => {
                allBooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderBooks();
            }, error => showToast("Kitaplar yüklenemedi: " + error.message, "error"));
        };
        
        const getStarRating = (r=0) => '★'.repeat(r) + '☆'.repeat(5 - r);
        
        const createBookCard = (book) => {
            const card = document.createElement('div');
            card.className = `book-card`;
            card.dataset.id = book.id;
            const coverUrl = (book.coverUrl || '').replace('http://', 'https://');
            const placeholder = `https://via.placeholder.com/110x165/e2e8f0/718096?text=Kapak`;
            card.innerHTML = `<div class="card-cover"><img src="${coverUrl || placeholder}" alt="${book.title}" loading="lazy" onerror="this.onerror=null;this.src='${placeholder}';"></div>
                                      <div class="card-info"><h3>${book.title || 'İsimsiz'}</h3><p>${book.author || 'Bilinmiyor'}</p><p class="book-rating">${getStarRating(book.rating)}</p></div>`;
            card.onclick = () => renderDetailsModal(book);
            return card;
        };

        const renderBooks = () => {
            let booksToRender = [...allBooks]; 
            const sortValue = ui.sortBy.value;
            if (sortValue === 'title_asc') {
                booksToRender.sort((a, b) => (a.title || '').localeCompare(b.title || '', 'tr', { sensitivity: 'base' }));
            } else {
                // The default is already sorted by dateAdded desc from Firestore query
            }
            const searchTerm = ui.searchInput.value.toLowerCase();
            const currentFilter = ui.filterStatus.value;
            const filteredBooks = booksToRender.filter(book => (book.title?.toLowerCase().includes(searchTerm) || book.author?.toLowerCase().includes(searchTerm)) && (currentFilter === 'Tümü' || book.status === currentFilter));
            ui.bookList.innerHTML = '';
            if (filteredBooks.length === 0) {
                ui.bookList.innerHTML = `<p style="text-align:center; color: var(--secondary-text); grid-column: 1 / -1; margin-top: 40px; font-size: 1.2em;">Sonuç bulunamadı.</p>`;
            } else {
                filteredBooks.forEach(book => ui.bookList.appendChild(createBookCard(book)));
            }
        };

        const openModal = (content) => { ui.modalContainer.innerHTML = `<div class="modal"><div class="modal-content">${content}</div></div>`; ui.modalContainer.querySelector('.close-button')?.addEventListener('click', closeModal); };
        const closeModal = () => { const modal = ui.modalContainer.querySelector('.modal'); if (modal) modal.remove(); };
        window.onclick = e => { if (e.target?.classList.contains('modal')) closeModal(); };
        
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.style.cssText = `position:fixed; bottom:20px; left:50%; transform:translateX(-50%) translateY(20px); background-color:${type === 'error' ? 'var(--danger-color)' : 'var(--success-color)'}; color:white; padding:15px 25px; border-radius:var(--border-radius-md); box-shadow:var(--shadow-lg); z-index:9999; opacity:0; transition: all 0.3s ease-out; font-family: var(--font-body);`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(-50%) translateY(0)';
            }, 10);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(20px)';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        };
        
        const renderBookFormModal = (book = {}) => {
            const isEditing = !!book.id;
            const title = isEditing ? 'Kitabı Düzenle' : 'Yeni Kitap Ekle';
            const content = `
                <div class="modal-header">
                    <h2>${title}</h2>
                    <button class="close-button">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="book-form" onsubmit="return false;">
                        <fieldset class="fieldset"><legend>Temel Bilgiler</legend>
                            <div class="form-group" style="position:relative;">
                                <label for="title">Kitap Adı</label>
                                <input type="text" id="title" value="${book.title || ''}" required autocomplete="off">
                                <div id="api-results" class="hidden"></div>
                            </div>
                            <div class="form-group"><label for="author">Yazar</label><input type="text" id="author" value="${book.author || ''}" required></div>
                            <div class="form-group"><label for="publisher">Yayınevi</label><input type="text" id="publisher" value="${book.publisher || ''}"></div>
                            <div class="form-group"><label for="page-count">Sayfa Sayısı</label><input type="number" id="page-count" value="${book.pageCount || ''}" min="0"></div>
                        </fieldset>
                        <fieldset class="fieldset"><legend>Kapak Görseli</legend>
                            <div class="form-group"><label for="cover-url">URL ile Ekle</label><input type="text" id="cover-url" value="${book.coverUrl || ''}" placeholder="Resim adresini buraya yapıştırın"></div>
                            <button type="button" id="google-cover-search-btn" class="btn btn-secondary">Google'da Kapak Ara</button>
                        </fieldset>
                        <fieldset class="fieldset"><legend>Okuma Bilgileri</legend>
                            <div class="form-group"><label for="status">Durum</label><select id="status"></select></div>
                            <div class="form-group"><label for="rating">Puan (0-5)</label><input type="number" id="rating" min="0" max="5" step="1" value="${book.rating || 0}"></div>
                            <div class="form-group hidden" id="date-fields"></div>
                        </fieldset>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="form-submit-btn" type="button" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                        Kaydet
                    </button>
                </div>`;
            openModal(content);
            const form = document.getElementById('book-form');
            const statusSelect = form.querySelector('#status');
            ['Okunacak', 'Okunuyor', 'Okundu'].forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; if(book.status===s) o.selected=true; statusSelect.appendChild(o); });
            const updateDateFields = () => {
                const fieldsDiv = form.querySelector('#date-fields');
                fieldsDiv.innerHTML = '';
                if (statusSelect.value === 'Okunuyor') {
                    fieldsDiv.innerHTML = `<label for="start-date">Başlama Tarihi</label><input type="date" id="start-date" value="${book.startDate || ''}">`;
                } else if (statusSelect.value === 'Okundu') {
                    fieldsDiv.innerHTML = `<label for="start-date">Başlama Tarihi</label><input type="date" id="start-date" value="${book.startDate || ''}"><div style="margin-top: 15px;"><label for="finish-date">Bitirme Tarihi</label><input type="date" id="finish-date" value="${book.finishDate || ''}"></div>`;
                }
                fieldsDiv.classList.toggle('hidden', statusSelect.value === 'Okunacak' || !statusSelect.value);
            };
            statusSelect.onchange = updateDateFields;
            updateDateFields();
            document.getElementById('form-submit-btn').onclick = () => handleBookFormSubmit(form, book);
            let searchTimeout;
            form.querySelector('#title').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => searchGoogleBooks(e.target.value), 400);
            });
            form.querySelector('#google-cover-search-btn').onclick = () => {
                const title = form.querySelector('#title').value;
                const author = form.querySelector('#author').value;
                if (!title) { showToast('Lütfen kapak aramadan önce Kitap Adı alanını doldurun.', 'error'); return; }
                const query = `${title} ${author} kitap kapağı`;
                const url = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`;
                window.open(url, '_blank');
            };
        };

        const searchGoogleBooks = async (query) => {
            const apiResultsDiv = document.getElementById('api-results');
            if (!apiResultsDiv || query.length < 3) { if(apiResultsDiv) apiResultsDiv.classList.add('hidden'); return; }
            apiResultsDiv.innerHTML = '<div class="api-result-item">Aranıyor...</div>';
            apiResultsDiv.classList.remove('hidden');
            try {
                const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=5&printType=books`);
                const data = await res.json();
                apiResultsDiv.innerHTML = '';
                if (!data.items) { apiResultsDiv.classList.add('hidden'); return; }
                data.items.forEach(item => {
                    const info = item.volumeInfo;
                    const bookData = { title: info.title || '', author: info.authors?.join(', ') || '', publisher: info.publisher || '', pageCount: info.pageCount || '', coverUrl: (info.imageLinks?.thumbnail || info.imageLinks?.smallThumbnail || '').replace('http://', 'https://') };
                    const div = document.createElement('div');
                    div.className = 'api-result-item';
                    div.innerHTML = `<strong>${bookData.title}</strong><br><small>${bookData.author}</small>`;
                    div.onclick = () => fillFormWithGoogleData(bookData);
                    apiResultsDiv.appendChild(div);
                });
            } catch (error) { console.error("API Hatası:", error); apiResultsDiv.classList.add('hidden'); }
        };

        const fillFormWithGoogleData = (bookData) => {
            const form = document.getElementById('book-form');
            if(!form) return;
            form.title.value = bookData.title;
            form.author.value = bookData.author;
            form.publisher.value = bookData.publisher;
            form.querySelector('#page-count').value = bookData.pageCount;
            form.querySelector('#cover-url').value = bookData.coverUrl;
            document.getElementById('api-results').classList.add('hidden');
        };

        const handleBookFormSubmit = async (form, existingBook) => {
            const submitButton = document.getElementById('form-submit-btn');
            submitButton.disabled = true;
            submitButton.innerHTML = "Kaydediliyor...";
            const newValues = {
                title: form.title.value, author: form.author.value, publisher: form.publisher.value,
                pageCount: parseInt(form['page-count'].value) || 0, coverUrl: form['cover-url'].value, status: form.status.value,
                rating: parseInt(form.rating.value) || 0, startDate: form['start-date']?.value || null, finishDate: form['finish-date']?.value || null
            };
            try {
                if (existingBook.id) {
                    await getBooksCollection().doc(existingBook.id).update(newValues);
                    showToast('Kitap güncellendi.', 'success');
                } else {
                    await getBooksCollection().add({ ...newValues, notes: [], dateAdded: FieldValue.serverTimestamp() });
                    showToast('Kitap eklendi.', 'success');
                }
                closeModal();
            } catch (error) { showToast(`Kitap kaydedilemedi: ${error.message}`,'error'); } 
            finally { if(submitButton) { submitButton.disabled = false; submitButton.innerHTML = "Kaydet"; } }
        };

        const renderDetailsModal = (book) => {
            const statusColors = { 'Okunacak': 'var(--secondary-text)', 'Okunuyor': 'var(--accent-1)', 'Okundu': 'var(--success-color)', 'Ödünç Verildi': 'var(--accent-2)' };
            const statusText = book.status === 'Ödünç Verildi' ? `${book.status} (${book.lentTo || 'Bilinmiyor'})` : book.status;
            const placeholder = `https://via.placeholder.com/200x300/e2e8f0/718096?text=Kapak`;
            const coverUrl = (book.coverUrl || '').replace('http://', 'https://');
            const content = `
                <div class="modal-header">
                    <h2>${book.title}</h2>
                    <button class="close-button">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="details-grid">
                        <div class="details-cover"><img src="${coverUrl || placeholder}" alt="${book.title}" onerror="this.onerror=null;this.src='${placeholder}';"></div>
                        <div>
                            <div class="details-info-grid">
                                <strong class="details-label">Yazar</strong> <div>${book.author || '-'}</div>
                                <strong class="details-label">Sayfa</strong> <div>${book.pageCount || '-'}</div>
                                <strong class="details-label">Puan</strong> <div><span class="book-rating">${getStarRating(book.rating)}</span></div>
                                <strong class="details-label">Durum</strong> <div><span style="padding: 4px 8px; color: white; border-radius: 4px; font-size: 0.9em; background-color:${statusColors[book.status] || '#ccc'}">${statusText}</span></div>
                                ${book.startDate ? `<strong class="details-label">Başlama</strong> <div>${new Date(book.startDate).toLocaleDateString('tr-TR')}</div>` : ''}
                                ${book.finishDate ? `<strong class="details-label">Bitirme</strong> <div>${new Date(book.finishDate).toLocaleDateString('tr-TR')}</div>` : ''}
                            </div>
                            <div id="notes-section"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-google-search btn" style="background-color:#4285F4; margin-right:auto;">Google'da Ara</button>
                    <button class="btn-edit btn-subtle">Düzenle</button>
                    ${book.status !== 'Ödünç Verildi' ? '<button class="btn-lend btn-secondary">Ödünç Ver</button>' : '<button class="btn-return btn-secondary">Geri Al</button>'}
                    <button class="btn-delete btn-danger">Sil</button>
                </div>`;
            openModal(content);
            const modalContent = ui.modalContainer.querySelector('.modal-content');
            modalContent.querySelector('.btn-edit').onclick = () => { closeModal(); renderBookFormModal(book); };
            modalContent.querySelector('.btn-delete').onclick = async (e) => {
                if(confirm('Bu kitabı silmek istediğinize emin misiniz? Bu işlem geri alınamaz.')){
                    e.target.disabled = true;
                    await getBooksCollection().doc(book.id).delete();
                    showToast('Kitap silindi.');
                    closeModal();
                }
            };
            modalContent.querySelector('.btn-google-search').onclick = () => {
                const query = `${book.title} ${book.author}`;
                const url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                window.open(url, '_blank');
            };
            const lendBtn = modalContent.querySelector('.btn-lend');
            if (lendBtn) lendBtn.onclick = () => handleLendBook(book);
            const returnBtn = modalContent.querySelector('.btn-return');
            if (returnBtn) returnBtn.onclick = () => handleReturnBook(book);
            renderNotes(book);
        };
        
        const handleLendBook = async (book) => {
            const lentTo = prompt(`"${book.title}" kitabını kime ödünç veriyorsunuz?`);
            if (lentTo && lentTo.trim()) {
                try {
                    await getBooksCollection().doc(book.id).update({ status: 'Ödünç Verildi', lentTo: lentTo.trim(), previousStatus: book.status });
                    showToast('Kitap ödünç verildi.', 'success');
                    closeModal();
                } catch (error) { showToast('İşlem sırasında bir hata oluştu.', 'error'); }
            }
        };

        const handleReturnBook = async (book) => {
            try {
                await getBooksCollection().doc(book.id).update({ status: book.previousStatus || 'Okunacak', lentTo: FieldValue.delete(), previousStatus: FieldValue.delete() });
                showToast('Kitap geri alındı.', 'success');
                closeModal();
            } catch (error) { showToast('İşlem sırasında bir hata oluştu.', 'error'); }
        };

        const renderNotes = (book) => {
            const notesSection = document.getElementById('notes-section');
            if(!notesSection) return;
            notesSection.innerHTML = `<h4 style="margin-top:20px; border-top:1px solid var(--border-color); padding-top:20px;">Kitap Notları</h4><div id="notes-list"></div><form id="note-form" style="margin-top:15px;" onsubmit="return false;"><div class="form-group"><textarea id="new-note-text" placeholder="Yeni bir not ekle..." rows="3" required></textarea><button type="submit" class="btn-primary" style="width:auto; float:right; margin-top:10px;">Not Ekle</button></div></form>`;
            const notesListDiv = document.getElementById('notes-list');
            notesListDiv.innerHTML = '';
            if (book.notes && book.notes.length > 0) {
                book.notes.sort((a,b) => new Date(b.id) - new Date(a.id)).forEach(note => {
                    const noteDiv = document.createElement('div');
                    noteDiv.className = 'note-item';
                    noteDiv.style.cssText = `background: var(--bg-color-alt); padding: 10px; border-radius: var(--border-radius-sm); margin-bottom: 10px; cursor: pointer;`;
                    noteDiv.innerHTML = `<p style="margin:0;">${note.text.replace(/\n/g, '<br>')}</p><small style="color:var(--secondary-text)">${new Date(note.id).toLocaleString('tr-TR')}</small>`;
                    noteDiv.onclick = () => { closeModal(); renderNoteForm(book, note); };
                    notesListDiv.appendChild(noteDiv);
                });
            } else {
                notesListDiv.innerHTML = '<p style="color:var(--secondary-text); text-align:center; padding:10px 0;">Henüz not eklenmemiş.</p>';
            }
            document.getElementById('note-form').onsubmit = (e) => {
                e.preventDefault();
                handleAddOrUpdateNote(book, null, e.target['new-note-text'].value);
                e.target.reset();
            };
        };
        
        const renderNoteForm = (book, note = {}) => {
            const isEditing = !!note.id;
            const content = `<div class="modal-header"><h2>Notu ${isEditing ? 'Düzenle': 'Ekle'}</h2><button class="close-button">&times;</button></div><div class="modal-body"><form id="edit-note-form"><div class="form-group"><textarea id="edit-note-text" rows="8" required>${note.text || ''}</textarea></div></form></div><div class="modal-footer">${isEditing ? '<button type="button" class="btn-delete-note btn-danger" style="margin-right:auto;">Sil</button>' : ''}<button type="button" id="save-note-btn" class="btn-primary">Kaydet</button></div>`;
            openModal(content);
            const form = ui.modalContainer.querySelector('#edit-note-form');
            document.getElementById('save-note-btn').onclick = () => {
                handleAddOrUpdateNote(book, note.id, form.querySelector('#edit-note-text').value);
            };
            const deleteBtn = ui.modalContainer.querySelector('.btn-delete-note');
            if(deleteBtn) deleteBtn.onclick = () => {
                if(confirm('Notu silmek istediğinize emin misiniz?')) handleAddOrUpdateNote(book, note.id, null);
            };
        };
        
        const handleAddOrUpdateNote = async (book, noteId, text) => {
            let currentNotes = book.notes || [];
            let toastMessage = "Not güncellendi.";
            if (text === null && noteId) { // Silme işlemi
                currentNotes = currentNotes.filter(n => n.id !== noteId);
                toastMessage = "Not silindi.";
            } else if (noteId) { // Düzenleme işlemi
                const noteIndex = currentNotes.findIndex(n => n.id === noteId);
                if (noteIndex > -1) currentNotes[noteIndex].text = text.trim();
            } else if (text && text.trim()){ // Ekleme işlemi
                currentNotes.push({ id: new Date().toISOString(), text: text.trim() });
                toastMessage = "Not eklendi.";
            } else {
                return; // Boş not eklemeyi önle
            }

            try {
                await getBooksCollection().doc(book.id).update({ notes: currentNotes });
                closeModal();
                const updatedBookForDisplay = { ...book, notes: currentNotes };
                renderDetailsModal(updatedBookForDisplay);
                showToast(toastMessage, "success");
            } catch (error) {
                showToast("Not güncellenirken bir hata oluştu: " + error.message, "error");
            }
        };

        const renderSettingsModal = () => {
            const currentTheme = localStorage.getItem('libraryTheme') || 'light';
            const content = `
                <div class="modal-header"><h2>Ayarlar</h2><button class="close-button">&times;</button></div>
                <div class="modal-body">
                    <fieldset class="fieldset"><legend>Görünüm Teması</legend>
                        <fieldset class="fieldset" style="margin-top:10px;"><legend>Pastel Temalar</legend>
                            <div class="theme-switcher">
                                <button class="theme-btn ${currentTheme === 'light' ? 'active' : ''}" data-theme="light">Açık</button>
                                <button class="theme-btn ${currentTheme === 'sepia' ? 'active' : ''}" data-theme="sepia">Sepya</button>
                                <button class="theme-btn ${currentTheme === 'nane-sekeri' ? 'active' : ''}" data-theme="nane-sekeri">Nane</button>
                                <button class="theme-btn ${currentTheme === 'lavanta-tarlasi' ? 'active' : ''}" data-theme="lavanta-tarlasi">Lavanta</button>
                                <button class="theme-btn ${currentTheme === 'vanilya-damlasi' ? 'active' : ''}" data-theme="vanilya-damlasi">Vanilya</button>
                                <button class="theme-btn ${currentTheme === 'somon-ruyasi' ? 'active' : ''}" data-theme="somon-ruyasi">Somon</button>
                                <button class="theme-btn ${currentTheme === 'gazete-kagidi' ? 'active' : ''}" data-theme="gazete-kagidi">Gazete</button>
                                <button class="theme-btn ${currentTheme === 'okyanus-esintisi' ? 'active' : ''}" data-theme="okyanus-esintisi">Okyanus</button>
                                <button class="theme-btn ${currentTheme === 'sade-beton' ? 'active' : ''}" data-theme="sade-beton">Beton</button>
                            </div>
                        </fieldset>
                        <fieldset class="fieldset" style="margin-top:10px;"><legend>Koyu Temalar</legend>
                            <div class="theme-switcher">
                                <button class="theme-btn ${currentTheme === 'dark' ? 'active' : ''}" data-theme="dark">Karanlık</button>
                                <button class="theme-btn ${currentTheme === 'gece-mavisi' ? 'active' : ''}" data-theme="gece-mavisi">Gece Mavisi</button>
                                <button class="theme-btn ${currentTheme === 'grafit-gecesi' ? 'active' : ''}" data-theme="grafit-gecesi">Grafit</button>
                                <button class="theme-btn ${currentTheme === 'zumrut-derinligi' ? 'active' : ''}" data-theme="zumrut-derinligi">Zümrüt</button>
                                <button class="theme-btn ${currentTheme === 'yakut-kirmizisi' ? 'active' : ''}" data-theme="yakut-kirmizisi">Yakut</button>
                                <button class="theme-btn ${currentTheme === 'retro-terminal' ? 'active' : ''}" data-theme="retro-terminal">Retro</button>
                                <button class="theme-btn ${currentTheme === 'gunes-batimi' ? 'active' : ''}" data-theme="gunes-batimi">G.Batımı</button>
                            </div>
                        </fieldset>
                    </fieldset>
                    <fieldset class="fieldset"><legend>Veri Yönetimi ve İstatistikler</legend>
                        <div style="display:flex; flex-direction:row; gap:10px; flex-wrap:wrap;">
                             <button id="stats-btn-modal" class="btn btn-secondary">İstatistikler</button>
                             <button id="import-btn-modal" class="btn btn-subtle">İçe Aktar</button>
                             <button id="export-btn-modal" class="btn btn-subtle">Dışa Aktar</button>
                             <button id="clean-duplicates-btn" class="btn btn-danger">Aynıları Sil</button>
                             <input type="file" id="import-file" class="hidden" accept=".json">
                        </div>
                    </fieldset>
                </div>`;
            openModal(content);
            const modalContent = ui.modalContainer.querySelector('.modal-content');
            modalContent.querySelectorAll('.theme-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const selectedTheme = e.target.dataset.theme;
                    applyTheme(selectedTheme);
                    modalContent.querySelector('.theme-btn.active')?.classList.remove('active');
                    e.target.classList.add('active');
                }
            });
            modalContent.querySelector('#stats-btn-modal').onclick = renderStatsModal;
            modalContent.querySelector('#import-btn-modal').onclick = () => document.getElementById('import-file').click();
            document.getElementById('import-file').onchange = handleImport;
            modalContent.querySelector('#export-btn-modal').onclick = handleExport;
            modalContent.querySelector('#clean-duplicates-btn').onclick = handleCleanDuplicates;
        };

        const renderStatsModal = () => {
            if (allBooks.length === 0) { showToast("İstatistik için henüz kitap eklenmemiş.", "error"); return; }
            const totalBooks = allBooks.length;
            const statusCounts = { 'Okundu': 0, 'Okunuyor': 0, 'Okunacak': 0, 'Ödünç Verildi': 0 };
            const authorCounts = {};
            let totalRating = 0, ratedBooks = 0, totalPagesRead = 0;
            allBooks.forEach(book => {
                if (book.status && statusCounts.hasOwnProperty(book.status)) statusCounts[book.status]++;
                if (book.author) authorCounts[book.author] = (authorCounts[book.author] || 0) + 1;
                if (book.rating > 0) { totalRating += book.rating; ratedBooks++; }
                if (book.status === 'Okundu' && book.pageCount > 0) totalPagesRead += book.pageCount;
            });
            const avgRating = ratedBooks > 0 ? (totalRating / ratedBooks).toFixed(1) : 'N/A';
            const topAuthors = Object.entries(authorCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);
            let statusBarHtml = Object.entries(statusCounts).map(([status, count]) => {
                const percentage = totalBooks > 0 ? ((count / totalBooks) * 100) : 0;
                return `<div class="bar-item"><div class="bar-label">${status} (${count})</div><div class="bar-wrapper" style="background-color: var(--bg-color-alt); border-radius: 4px; overflow: hidden;"><div class="bar" style="width: ${percentage}%; height: 1.2em; background-color: var(--accent-1); border-radius: 4px;"></div></div></div>`;
            }).join('');
            const content = `
                <div class="modal-header"><h2>Kütüphane İstatistikleri</h2><button class="close-button">&times;</button></div>
                <div class="modal-body">
                    <div class="stats-grid">
                        <div class="stat-card"><h3>${totalBooks}</h3><p>Toplam Kitap</p></div>
                        <div class="stat-card"><h3>${statusCounts['Okundu']}</h3><p>Okunmuş Kitap</p></div>
                        <div class="stat-card"><h3>${totalPagesRead.toLocaleString('tr-TR')}</h3><p>Okunan Sayfa</p></div>
                        <div class="stat-card"><h3>${avgRating}</h3><p>Ort. Puan</p></div>
                    </div>
                    <div class="chart-container" style="margin-top:25px;"><h4>Okuma Durumu Dağılımı</h4><div class="bar-chart">${statusBarHtml}</div></div>
                    ${topAuthors.length > 0 ? `<div class="chart-container" style="margin-top:25px;"><h4>En Popüler Yazarlar</h4><ol style="padding-left:20px;">${topAuthors.map(a => `<li>${a[0]} (${a[1]} kitap)</li>`).join('')}</ol></div>` : ''}
                </div>`;
            openModal(content);
        };
        
        const handleCleanDuplicates = async (e) => {
            const button = e.target;
            button.disabled = true;
            button.textContent = 'Taranıyor...';
            try {
                const seen = new Map();
                const idsToDelete = [];
                const sortedBooks = [...allBooks].sort((a,b) => (a.dateAdded?.toDate() || 0) - (b.dateAdded?.toDate() || 0));
                sortedBooks.forEach(book => {
                    const key = `${book.title?.trim().toLowerCase()}|${book.author?.trim().toLowerCase()}`;
                    if (seen.has(key)) { idsToDelete.push(book.id); } else { seen.set(key, book.id); }
                });
                if (idsToDelete.length === 0) { showToast('Kütüphanenizde aynı kayıttan birden fazla yok.', 'success'); } 
                else {
                    const confirmed = confirm(`${idsToDelete.length} adet mükerrer kitap kaydı bulundu. Silinecekler. Onaylıyor musunuz?`);
                    if (confirmed) {
                        button.textContent = 'Siliniyor...';
                        const batch = db.batch();
                        idsToDelete.forEach(id => { batch.delete(getBooksCollection().doc(id)); });
                        await batch.commit();
                        showToast(`${idsToDelete.length} adet mükerrer kayıt başarıyla silindi.`, 'success');
                    }
                }
                closeModal();
            } catch (error) { showToast('Kayıtları silerken bir hata oluştu.', 'error'); } 
            finally { if(button) { button.disabled = false; button.textContent = 'Aynıları Sil'; } }
        };

        const handleExport = () => {
            if (allBooks.length === 0) { showToast('Dışa aktarılacak kitap bulunmuyor.', 'error'); return; }
            const booksToExport = allBooks.map(book => {
                const cleanBook = { ...book };
                if (cleanBook.dateAdded && typeof cleanBook.dateAdded.toDate === 'function') {
                    cleanBook.dateAdded = cleanBook.dateAdded.toDate().toISOString();
                }
                if (cleanBook.notes) {
                    cleanBook.notes = cleanBook.notes.map(note => ({
                        id: note.id,
                        text: note.text
                    }));
                }
                return cleanBook;
            });
            const dataStr = JSON.stringify(booksToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.download = `kutuphanem-yedek-${new Date().toISOString().split('T')[0]}.json`;
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Kütüphane dışa aktarıldı.', 'success');
        };

        const handleImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedBooks = JSON.parse(e.target.result);
                    if (!Array.isArray(importedBooks)) throw new Error("JSON dosyası bir kitap listesi (dizi) içermiyor.");
                    const confirmed = confirm(`${importedBooks.length} adet kitap içe aktarılacak. Onaylıyor musunuz?`);
                    if (!confirmed) { document.getElementById('import-file').value = ''; return; }
                    
                    const batch = db.batch();
                    importedBooks.forEach(book => {
                        const newBookRef = getBooksCollection().doc();
                        const { id, ...bookData } = book;
                        batch.set(newBookRef, { ...bookData, dateAdded: FieldValue.serverTimestamp() });
                    });
                    await batch.commit();
                    showToast(`${importedBooks.length} kitap başarıyla içe aktarıldı.`, 'success');
                    closeModal();
                } catch (error) { showToast(`İçe aktarma başarısız: ${error.message}`, 'error'); } 
                finally { document.getElementById('import-file').value = ''; }
            };
            reader.readAsText(file);
        };
        
        const renderDiscoveryModal = () => {
            const content = `
                <div class="modal-header"><h2>Kitap Keşfet</h2><button class="close-button">&times;</button></div>
                <div class="modal-body">
                    <form id="discovery-form" onsubmit="return false;">
                        <div class="form-group" style="display:flex; gap:10px; align-items:center;">
                            <input type="text" id="discovery-search-input" placeholder="Kitap veya yazar adı girin..." required style="flex-grow:1;">
                            <button type="submit" class="btn btn-secondary">API'de Ara</button>
                            <button type="button" id="discovery-google-search-btn" class="btn" style="background-color:#4285F4;">Google'da Ara</button>
                        </div>
                    </form>
                    <div id="discovery-results-container"><p style="text-align:center; color: var(--secondary-text);">Yeni kitaplar keşfetmek için arama yapın.</p></div>
                </div>`;
            openModal(content);
            document.getElementById('discovery-form').onsubmit = async (e) => {
                e.preventDefault();
                const query = document.getElementById('discovery-search-input').value;
                const resultsContainer = document.getElementById('discovery-results-container');
                resultsContainer.innerHTML = '<p>Aranıyor...</p>';
                try {
                    const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=20&printType=books`);
                    const data = await res.json();
                    if (!data.items) { resultsContainer.innerHTML = '<p>Sonuç bulunamadı.</p>'; return; }
                    displayDiscoveryResults(data.items);
                } catch (error) { resultsContainer.innerHTML = '<p>Arama sırasında bir hata oluştu.</p>'; }
            };
            document.getElementById('discovery-google-search-btn').onclick = () => {
                const query = document.getElementById('discovery-search-input').value;
                if (!query.trim()) { showToast('Lütfen arama yapmak için bir metin girin.', 'error'); return; }
                const url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                window.open(url, '_blank');
            };
        };

        const displayDiscoveryResults = (items) => {
            const resultsContainer = document.getElementById('discovery-results-container');
            resultsContainer.innerHTML = `<div id="discovery-results-list"></div>`;
            const listDiv = document.getElementById('discovery-results-list');
            items.forEach(itemData => {
                const info = itemData.volumeInfo;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'discovery-item';
                const cover = info.imageLinks?.thumbnail || `https://via.placeholder.com/50x75/e2e8f0/718096?text=?`;
                itemDiv.innerHTML = `<img src="${cover}" alt="${info.title}"><div class="discovery-item-info"><h4>${info.title}</h4><p>${info.authors?.join(', ') || 'Bilinmeyen Yazar'} (${info.publishedDate?.substring(0,4) || 'N/A'})</p></div>`;
                itemDiv.onclick = () => displayDiscoveryDetail(itemData);
                listDiv.appendChild(itemDiv);
            });
        };

        const displayDiscoveryDetail = (itemData) => {
            const modalBody = document.querySelector('.modal-body');
            const info = itemData.volumeInfo;
            const bookForLibrary = { title: info.title || '', author: info.authors?.join(', ') || '', publisher: info.publisher || '', pageCount: info.pageCount || 0, coverUrl: info.imageLinks?.thumbnail || '' };
            const cover = info.imageLinks?.thumbnail || `https://via.placeholder.com/200x300/e2e8f0/718096?text=Kapak`;
            modalBody.innerHTML = `
                <div class="details-grid">
                    <div class="details-cover"><img src="${cover}" alt="${info.title}"></div>
                    <div>
                        <h4>${info.title}</h4>
                        <p><strong>Yazar:</strong> ${info.authors?.join(', ') || '-'}</p>
                        <p><strong>Yayınevi:</strong> ${info.publisher || '-'}</p>
                        <p><strong>Yayın Yılı:</strong> ${info.publishedDate?.substring(0,4) || '-'}</p>
                        <p><strong>Sayfa Sayısı:</strong> ${info.pageCount || '-'}</p>
                        <div style="max-height: 200px; overflow-y:auto; margin-top:15px; border-top: 1px solid var(--border-color); padding-top:15px; font-size: 0.9em;">
                           ${info.description || 'Bu kitap için özet bulunamadı.'}
                        </div>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                    <button id="back-to-discovery-results" class="btn btn-subtle">« Geri</button>
                    <div>
                        <button id="google-search-discovered-book" class="btn" style="background-color:#4285F4; margin-right:10px;">Google'da Ara</button>
                        <button id="add-discovered-book" class="btn btn-primary">Kütüphaneme Ekle</button>
                    </div>
                </div>`;
            modalBody.querySelector('#back-to-discovery-results').onclick = () => { closeModal(); renderDiscoveryModal(); };
            modalBody.querySelector('#add-discovered-book').onclick = () => { closeModal(); renderBookFormModal(bookForLibrary); };
            modalBody.querySelector('#google-search-discovered-book').onclick = () => {
                const query = `${info.title} ${info.authors ? info.authors.join(' ') : ''}`;
                const url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                window.open(url, '_blank');
            };
        };

        const getPrivateNotesCollection = () => db.collection('users').doc(currentUser.uid).collection('privateNotes');

        const renderPrivateNotesModal = async () => {
            const content = `
                <div class="modal-header">
                    <h2>Özel Notlarım</h2>
                    <button class="close-button">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="private-notes-list"><p>Notlar yükleniyor...</p></div>
                </div>
                <div class="modal-footer">
                     <button id="add-new-private-note" class="btn btn-primary">Yeni Not Ekle</button>
                </div>`;
            openModal(content);
            
            const listContainer = document.getElementById('private-notes-list');
            try {
                const snapshot = await getPrivateNotesCollection().orderBy('createdAt', 'desc').get();
                if (snapshot.empty) {
                    listContainer.innerHTML = '<p style="text-align:center; color: var(--secondary-text);">Henüz özel notunuz bulunmuyor.</p>';
                } else {
                    listContainer.innerHTML = '';
                    snapshot.docs.forEach(doc => {
                        const note = { id: doc.id, ...doc.data() };
                        const noteDiv = document.createElement('div');
                        noteDiv.className = 'private-note-item';
                        const noteDate = note.createdAt?.toDate ? note.createdAt.toDate() : new Date();
                        noteDiv.innerHTML = `
                            <p>${note.text.replace(/\n/g, '<br>')}</p>
                            <small>${noteDate.toLocaleString('tr-TR')}</small>
                        `;
                        noteDiv.onclick = () => renderPrivateNoteFormModal(note);
                        listContainer.appendChild(noteDiv);
                    });
                }
            } catch(error) {
                listContainer.innerHTML = '<p>Notlar yüklenirken bir hata oluştu.</p>';
                showToast("Notlar yüklenemedi: " + error.message, "error");
            }
            
            document.getElementById('add-new-private-note').onclick = () => renderPrivateNoteFormModal();
        };

        const renderPrivateNoteFormModal = (note = {}) => {
            const isEditing = !!note.id;
            const content = `
                <div class="modal-header">
                    <h2>${isEditing ? 'Notu Düzenle' : 'Yeni Not Ekle'}</h2>
                    <button class="close-button">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="private-note-form" onsubmit="return false;">
                        <div class="form-group">
                            <textarea id="private-note-text" rows="10" required placeholder="Notunuzu buraya yazın...">${note.text || ''}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    ${isEditing ? `<button id="delete-private-note-btn" class="btn btn-danger" style="margin-right: auto;">Sil</button>` : ''}
                    <button id="save-private-note-btn" class="btn btn-primary">Kaydet</button>
                </div>`;
            openModal(content);

            document.getElementById('save-private-note-btn').onclick = async () => {
                const text = document.getElementById('private-note-text').value;
                await handleSavePrivateNote(note.id, text);
            };

            const deleteBtn = document.getElementById('delete-private-note-btn');
            if (deleteBtn) {
                deleteBtn.onclick = async () => {
                    if (confirm('Bu notu kalıcı olarak silmek istediğinizden emin misiniz?')) {
                       await handleDeletePrivateNote(note.id);
                    }
                };
            }
        };

        const handleSavePrivateNote = async (noteId, text) => {
            if (!text || !text.trim()) {
                showToast("Not boş olamaz.", "error");
                return;
            }
            try {
                if (noteId) { // Düzenleme
                    await getPrivateNotesCollection().doc(noteId).update({
                        text: text.trim(),
                        lastEdited: FieldValue.serverTimestamp()
                    });
                    showToast("Not güncellendi.", "success");
                } else { // Yeni not
                    await getPrivateNotesCollection().add({
                        text: text.trim(),
                        createdAt: FieldValue.serverTimestamp()
                    });
                    showToast("Not eklendi.", "success");
                }
                closeModal();
                renderPrivateNotesModal();
            } catch (error) {
                showToast("Not kaydedilemedi: " + error.message, "error");
            }
        };

        const handleDeletePrivateNote = async (noteId) => {
            try {
                await getPrivateNotesCollection().doc(noteId).delete();
                showToast("Not silindi.", "success");
                closeModal();
                renderPrivateNotesModal();
            } catch (error) {
                showToast("Not silinemedi: " + error.message, "error");
            }
        };
        
        // --- Ana Event Listeners ---
        ui.addBookBtn.onclick = () => renderBookFormModal();
        ui.discoverBooksBtn.onclick = renderDiscoveryModal;
        ui.privateNotesBtn.onclick = renderPrivateNotesModal;
        ui.searchInput.addEventListener('input', renderBooks);
        ui.filterStatus.addEventListener('change', renderBooks);
        ui.sortBy.addEventListener('change', renderBooks);
        ui.settingsBtn.onclick = renderSettingsModal;
    });
    </script>
</body>
</html>
