<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benim Güzel Kütüphanem</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Zilla+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f7f9; --card-bg: #ffffff; --primary-text: #2d3748; --secondary-text: #718096;
            --accent-1: #ff6347; --accent-1-dark: #e5533d; --accent-2: #00b894; --accent-2-dark: #00a383;
            --accent-3: #4a90e2; --accent-4: #8e44ad; --success-color: #2ecc71; --danger-color: #e74c3c;
            --border-color: #e2e8f0; --font-heading: 'Zilla Slab', serif; --font-body: 'Poppins', sans-serif;
            --modal-header-bg: var(--accent-1);
        }
        body[data-theme="ocean"] {
            --accent-1: #3498db; --accent-1-dark: #2980b9; --accent-2: #1abc9c; --accent-2-dark: #16a085;
        }
        body[data-theme="forest"] {
            --accent-1: #27ae60; --accent-1-dark: #229954; --accent-2: #f39c12; --accent-2-dark: #d68910;
        }
        body[data-theme="dusk"] {
            --bg-color: #34495e; --card-bg: #46627f; --primary-text: #ecf0f1; --secondary-text: #bdc3c7;
            --border-color: #5d7c9a; --accent-1: #e74c3c; --accent-1-dark: #c0392b; --accent-2: #9b59b6;
        }

        *, *::before, *::after { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-body); margin: 0; background-color: var(--bg-color);
            color: var(--primary-text); font-size: 16px; line-height: 1.6; transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 1200px; margin: 20px auto; padding: 15px; }
        h1, h2, h3, h4 { font-family: var(--font-heading); margin-top: 0; color: var(--primary-text); font-weight: 700; }
        header { text-align: center; padding: 1rem; margin-bottom: 20px; }
        header h1 { font-size: 3.5em; margin: 0; }
        .controls-bar { padding: 25px; background-color: var(--card-bg); border-radius: 16px; box-shadow: 0 6px 20px rgba(45, 55, 72, 0.08); display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; border: 1px solid var(--border-color); }
        .top-controls, .bottom-controls { display: flex; align-items: center; flex-wrap: wrap; gap: 15px; }
        .top-controls { justify-content: flex-start; }
        button { background-color: var(--accent-1); color: white; padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.2s ease-in-out; letter-spacing: 0.5px; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(45, 55, 72, 0.1); }
        button:disabled { background-color: #ccc; cursor: not-allowed; transform: translateY(0); box-shadow: none; }
        .controls-bar select, .controls-bar input[type="text"] { padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background-color: var(--card-bg); color: var(--primary-text); min-width: 180px; transition: border-color 0.2s, box-shadow 0.2s; }
        .controls-bar input[type="text"] { flex-grow: 1; }
        .controls-bar select:focus, .controls-bar input[type="text"]:focus { outline: none; border-color: var(--accent-1); box-shadow: 0 0 0 3px rgba(255, 99, 71, 0.2); }
        .list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .book-card { background-color: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 15px rgba(45, 55, 72, 0.07); overflow: hidden; display: flex; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid var(--border-color); }
        .book-card:hover { transform: translateY(-6px); box-shadow: 0 10px 25px rgba(45, 55, 72, 0.1); }
        .card-cover img { width: 110px; height: 165px; object-fit: cover; display: block; }
        .card-info { padding: 20px; display: flex; flex-direction: column; justify-content: center; flex-grow: 1; overflow: hidden; }
        .card-info h3 { margin: 0 0 5px 0; font-size: 1.3em; color: var(--primary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-info p { margin: 2px 0; font-size: 1em; color: var(--secondary-text); }
        .book-rating { color: var(--accent-3); font-size: 1.3em; margin-top: 10px !important; letter-spacing: 2px; }
        .modal { display: flex; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(45, 55, 72, 0.6); backdrop-filter: blur(8px); animation: fadeIn 0.3s; padding: 5vh 15px; align-items: flex-start; justify-content: center; overflow-y: auto; }
        .modal-content { background-color: var(--card-bg); padding: 0; border-radius: 16px; width: 90%; max-width: 700px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.1); animation: slideIn 0.3s; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { padding: 20px 40px; border-bottom: 1px solid var(--border-color); background-color: var(--modal-header-bg); border-radius: 16px 16px 0 0; }
        .modal-header h2 { color: white; margin: 0; }
        .modal-body { padding: 30px 40px; overflow-y: auto; }
        .close-button { color: #fff; position: absolute; top: 18px; right: 25px; font-size: 36px; font-weight: 400; cursor: pointer; transition: transform 0.2s; line-height: 1; }
        .close-button:hover { transform: scale(1.1); }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        body[data-theme="dusk"] .form-group label { color: var(--secondary-text); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background-color: #fff; color:var(--primary-text); box-sizing: border-box; }
        body[data-theme="dusk"] .form-group input, body[data-theme="dusk"] .form-group select, body[data-theme="dusk"] .form-group textarea { background-color: var(--bg-color); border-color: var(--border-color); }
        .fieldset { border: 1px solid var(--border-color); border-radius: 12px; padding: 10px 20px 20px 20px; margin-bottom: 25px; }
        .fieldset legend { font-family: var(--font-heading); font-weight: 700; color: var(--secondary-text); padding: 0 10px; }
        #api-results { position: absolute; background: white; width: calc(100% - 2px); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 10px 10px; z-index: 10; max-height: 250px; overflow-y: auto; box-shadow: 0 8px 15px rgba(45,55,72,0.1); margin-top: -1px; }
        .api-result-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .api-result-item:last-child { border-bottom: none; } .api-result-item:hover { background-color: #f4f7f9; }
        .api-result-item p { margin: 0; } .api-result-item .title { font-weight: 600; } .api-result-item .author { font-size: 0.9em; color: var(--secondary-text); }
        .hidden { display: none; }
        .toast { /* ... (no changes) ... */ }
        .details-grid { display: grid; grid-template-columns: 200px 1fr; gap: 40px; align-items: flex-start; }
        .details-cover img { width: 200px; height: auto; border-radius: 12px; box-shadow: 0 8px 25px rgba(45,55,72,0.15); }
        .details-info-grid { display: grid; grid-template-columns: 100px 1fr; gap: 12px 18px; align-items: center; }
        .details-label { font-weight: 600; color: var(--secondary-text); }
        .details-status { padding: 5px 12px; border-radius: 15px; font-size: 0.9em; font-weight: 700; color: white; text-align: center; display: inline-block; }
        #notes-section, #summary-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        #summary-section p { white-space: pre-wrap; max-height: 200px; overflow-y: auto; background-color: var(--bg-color); padding: 15px; border-radius: 8px; }
        .note-item { /* ... (no changes) ... */ }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; text-align: center; }
        .stat-card { background-color: var(--bg-color); padding: 20px; border-radius: 16px; border: 1px solid var(--border-color); }
        .stat-card h3 { font-family: var(--font-body); font-size: 2.5em; color: var(--accent-1); margin: 0 0 5px 0; }
        .stat-card p { margin: 0; color: var(--secondary-text); font-weight: 600; }
        .settings-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .settings-section:last-child { border-bottom: none; }
        .settings-section h3 { margin-bottom: 15px; }
        .settings-controls { display: flex; flex-wrap: wrap; gap: 15px; }
        @media (max-width: 768px) {
            .details-grid { grid-template-columns: 1fr; text-align: center; }
            .details-cover { margin: 0 auto 20px auto; }
            .details-info-grid { grid-template-columns: 100px 1fr; text-align: left; }
            .modal-header { padding: 15px 20px; }
            .modal-body { padding: 20px; }
            .close-button { right: 15px; top: 12px;}
            header h1 { font-size: 2.5em; }
        }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes slideIn { from {transform: translateY(-20px) scale(0.98); opacity: 0;} to {transform: translateY(0) scale(1); opacity: 1;} }
    </style>
</head>
<body data-theme="default">

    <div id="login-screen" style="text-align: center; padding-top: 20vh;">
        <header><h1>Benim Güzel Kütüphanem</h1></header>
        <button id="login-btn">Google ile Giriş Yap</button>
    </div>

    <div id="main-app" class="hidden">
        <header>
            <h1>Benim Güzel Kütüphanem</h1>
            <div class="user-profile" style="font-weight: 600; display:flex; align-items:center; justify-content:center;">
                <span id="user-display-name"></span>
                <button id="logout-btn" style="background:var(--secondary-text); margin-left:15px; font-size:0.8em; padding:8px 12px;">Çıkış Yap</button>
            </div>
        </header>
        <div class="container">
            <main id="library-view">
                <div class="controls-bar">
                    <div class="top-controls">
                        <button id="add-book-btn">Yeni Kitap Ekle</button>
                        <button id="show-stats-btn" style="background-color:var(--accent-2);">İstatistikler</button>
                        <button id="settings-btn" style="background-color:var(--accent-3);">Ayarlar</button>
                        <input type="text" id="search-input" placeholder="Kütüphanede ara...">
                    </div>
                    <div class="bottom-controls">
                        <select id="filter-status" style="flex:1;">
                            <option value="Tümü">Filtrele: Tümü</option><option value="Okunacak">Okunacak</option><option value="Okunuyor">Okunuyor</option><option value="Okundu">Okundu</option><option value="Ödünç Verildi">Ödünç Verildi</option>
                        </select>
                        <select id="sort-by" style="flex:1;">
                            <option value="dateAdded_desc">Sırala: Eklenme Tarihi (Yeni)</option>
                            <option value="title_asc" selected>Sırala: Ada Göre (A-Z)</option>
                        </select>
                    </div>
                </div>
                <div class="list-container" id="book-list"></div>
            </main>
        </div>
        <div id="modal-container"></div>
    </div>
    
    <input type="file" id="import-file" class="hidden" accept=".json">

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = { /* GÜVENLİK UYARISI: Bu anahtarları normalde bu şekilde paylaşmayın. */
            apiKey: "AIzaSyASaHGgjR-zsQ50E9JmCcBnBq2KyXcltuE", authDomain: "benim-kutuphanem402.firebaseapp.com",
            projectId: "benim-kutuphanem402", storageBucket: "benim-kutuphanem402.appspot.com",
            messagingSenderId: "400988696330", appId: "1:400988696330:web:d9e2f0fa4301c2c8f714f3"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue;

        let allBooks = [];
        let currentUser = null;
        let unsubscribeBooks = null;

        const ui = {
            loginScreen: document.getElementById('login-screen'), mainApp: document.getElementById('main-app'),
            loginBtn: document.getElementById('login-btn'), logoutBtn: document.getElementById('logout-btn'),
            userDisplayName: document.getElementById('user-display-name'), bookList: document.getElementById('book-list'),
            searchInput: document.getElementById('search-input'), filterStatus: document.getElementById('filter-status'), 
            sortBy: document.getElementById('sort-by'), modalContainer: document.getElementById('modal-container'),
            importFile: document.getElementById('import-file'),
        };
        
        // --- TEMA YÖNETİMİ ---
        const applyTheme = (theme) => {
            document.body.dataset.theme = theme;
            localStorage.setItem('libraryTheme', theme);
        };
        const savedTheme = localStorage.getItem('libraryTheme') || 'default';
        applyTheme(savedTheme);

        // --- KİMLİK DOĞRULAMA ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                ui.loginScreen.classList.add('hidden'); ui.mainApp.classList.remove('hidden');
                ui.userDisplayName.textContent = `Hoş geldin, ${user.displayName.split(' ')[0]}`;
                loadBooks();
            } else {
                currentUser = null;
                ui.loginScreen.classList.remove('hidden'); ui.mainApp.classList.add('hidden');
                if (unsubscribeBooks) unsubscribeBooks();
            }
        });
        ui.loginBtn.onclick = () => { const p = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(p).catch(e => console.error("Giriş Hatası:", e)); };
        ui.logoutBtn.onclick = () => auth.signOut();

        const getBooksCollection = () => db.collection('users').doc(currentUser.uid).collection('books');

        const loadBooks = () => {
            if (unsubscribeBooks) unsubscribeBooks();
            // Sıralama artık renderBooks içinde yapıldığı için Firestore sorgusunu basitleştirebiliriz.
            let query = getBooksCollection();
            unsubscribeBooks = query.onSnapshot(snapshot => {
                allBooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderBooks();
            }, error => showToast("Kitaplar yüklenemedi: " + error.message, "error"));
        };
        
        // --- ARAYÜZ ÇİZİM FONKSİYONLARI ---
        const getStarRating = (r=0) => '★'.repeat(r) + '☆'.repeat(5 - r);
        const createBookCard = (book) => {
            const card = document.createElement('div');
            card.className = `book-card`;
            card.dataset.id = book.id;
            const coverUrl = (book.coverUrl || '').replace('http://', 'https://');
            const placeholder = `https://via.placeholder.com/110x165/e2e8f0/718096?text=Kapak`;
            card.innerHTML = `<div class="card-cover"><img src="${coverUrl || placeholder}" alt="${book.title}" loading="lazy"></div>
                                <div class="card-info"><h3>${book.title}</h3><p>${book.author}</p><p class="book-rating">${getStarRating(book.rating)}</p></div>`;
            card.onclick = () => renderDetailsModal(book);
            return card;
        };

        const renderBooks = () => {
            let booksToRender = [...allBooks]; 
            const [sortField, sortOrder] = ui.sortBy.value.split('_');

            if (sortField === 'title') {
                booksToRender.sort((a, b) => (a.title || '').localeCompare(b.title || '', 'tr', { sensitivity: 'base' }));
            } else if (sortField === 'dateAdded') {
                booksToRender.sort((a, b) => (b.dateAdded?.toMillis() || 0) - (a.dateAdded?.toMillis() || 0));
            }

            const searchTerm = ui.searchInput.value.toLowerCase();
            const currentFilter = ui.filterStatus.value;
            const filteredBooks = booksToRender.filter(book => (book.title?.toLowerCase().includes(searchTerm) || book.author?.toLowerCase().includes(searchTerm)) && (currentFilter === 'Tümü' || book.status === currentFilter));
            
            ui.bookList.innerHTML = '';
            if (filteredBooks.length === 0) {
                ui.bookList.innerHTML = `<p style="text-align:center; color: var(--secondary-text); grid-column: 1 / -1; margin-top: 20px;">Bu kriterlere uygun kitap bulunamadı.</p>`;
            } else {
                filteredBooks.forEach(book => ui.bookList.appendChild(createBookCard(book)));
            }
        };

        // --- MODAL YÖNETİMİ ---
        const openModal = (content, headerText, headerColor) => {
            const modalHTML = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="background-color: ${headerColor};">
                            <h2>${headerText}</h2>
                            <span class="close-button" aria-label="Kapat">&times;</span>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                    </div>
                </div>`;
            ui.modalContainer.innerHTML = modalHTML;
            ui.modalContainer.querySelector('.close-button')?.addEventListener('click', closeModal);
        };
        const closeModal = () => { const modal = ui.modalContainer.querySelector('.modal'); if (modal) modal.remove(); };
        window.onclick = e => { if (e.target?.classList.contains('modal')) closeModal(); };
        const showToast = (message, type = 'success') => {
             const toast = document.createElement('div');
             toast.className = 'toast';
             if(type === 'error') toast.style.backgroundColor = 'var(--danger-color)';
             if(type === 'success') toast.style.backgroundColor = 'var(--success-color)';
             toast.textContent = message;
             document.body.appendChild(toast);
             setTimeout(() => {
                 toast.style.opacity = '1';
                 toast.style.transform = 'translateX(-50%) translateY(0)';
             }, 100);
             setTimeout(() => {
                 toast.style.opacity = '0';
                 toast.style.transform = 'translateX(-50%) translateY(20px)';
                 setTimeout(() => document.body.removeChild(toast), 500);
             }, 3000);
        };

        // --- ANA FORM VE CRUD ---
        const renderBookFormModal = (book = {}) => {
            const isEditing = !!book.id;
            const title = isEditing ? 'Kitabı Düzenle' : 'Yeni Kitap Ekle';
            const content = `
                <form id="book-form">
                    <input type="hidden" id="summary" value="${book.summary || ''}">
                    <fieldset><legend>Temel Bilgiler</legend>
                        <div class="form-group" style="position:relative;">
                            <label for="title">Kitap Adı</label>
                            <input type="text" id="title" value="${book.title || ''}" required autocomplete="off">
                            <div id="api-results" class="hidden"></div>
                        </div>
                        <div class="form-group"><label for="author">Yazar</label><input type="text" id="author" value="${book.author || ''}" required></div>
                        <div class="form-group" style="margin-bottom:0;"><label for="publisher">Yayınevi</label><input type="text" id="publisher" value="${book.publisher || ''}"></div>
                    </fieldset>
                    <fieldset><legend>Okuma Bilgileri</legend>
                        <div class="form-group"><label for="status">Durum</label><select id="status"></select></div>
                        <div class="form-group"><label for="rating">Puan (0-5)</label><input type="number" id="rating" min="0" max="5" step="1" value="${book.rating || 0}"></div>
                        <div class="form-group hidden" id="date-fields" style="margin-bottom:0;"></div>
                    </fieldset>
                    <div style="text-align:right; margin-top:30px;"><button type="submit">Kaydet</button></div>
                </form>`;
            openModal(content, title, 'var(--accent-1)');
            const form = document.getElementById('book-form');
            const statusSelect = form.querySelector('#status');
            ['Okunacak', 'Okunuyor', 'Okundu'].forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; if(book.status===s) o.selected=true; statusSelect.appendChild(o); });
            const updateDateFields = () => { /* ... (no changes) ... */ };
            statusSelect.onchange = updateDateFields; updateDateFields();
            form.onsubmit = (e) => handleBookFormSubmit(e, book);
            let searchTimeout;
            form.querySelector('#title').addEventListener('keyup', (e) => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => searchGoogleBooks(e.target.value), 400); });
        };
        
        const handleBookFormSubmit = async (e, existingBook) => {
             e.preventDefault(); const form = e.target;
             const submitButton = form.querySelector('button[type="submit"]');
             submitButton.disabled = true; submitButton.textContent = "Kaydediliyor...";
             const newValues = {
                 title: form.title.value, author: form.author.value, publisher: form.publisher.value,
                 status: form.status.value, rating: parseInt(form.rating.value) || 0,
                 summary: form.summary.value || '', // Özet bilgisini al
                 // Diğer alanlar...
             };
             // Kapak URL'si gibi diğer alanları da eklemeyi unutmayın...
             // coverUrl: form['cover-url']?.value || '', // Örnek
             
             try {
                 if (existingBook.id) {
                     await getBooksCollection().doc(existingBook.id).update(newValues);
                     showToast('Kitap güncellendi.', 'success');
                 } else {
                     await getBooksCollection().add({ ...newValues, notes: [], dateAdded: FieldValue.serverTimestamp() });
                     showToast('Kitap eklendi.', 'success');
                 }
                 closeModal();
             } catch (error) {
                 console.error("Kitap kaydetme hatası: ", error);
                 showToast('Kitap kaydedilemedi.','error');
             } finally {
                 if(submitButton) { submitButton.disabled = false; submitButton.textContent = "Kaydet"; }
             }
        };

        // --- GOOGLE BOOKS API & ÖZET İŞLEMLERİ ---
        const searchGoogleBooks = async (query) => {
            const apiResultsDiv = document.getElementById('api-results');
            if (!apiResultsDiv || query.length < 3) { if(apiResultsDiv) apiResultsDiv.classList.add('hidden'); return; }
            apiResultsDiv.innerHTML = '<div class="api-result-item">Aranıyor...</div>';
            apiResultsDiv.classList.remove('hidden');
            try {
                const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=5&printType=books`);
                const data = await res.json();
                apiResultsDiv.innerHTML = '';
                if (!data.items) { apiResultsDiv.classList.add('hidden'); return; }

                data.items.forEach(item => {
                    const info = item.volumeInfo;
                    const bookData = {
                        title: info.title || '', author: info.authors?.join(', ') || '', publisher: info.publisher || '',
                        summary: info.description || '' // Özet bilgisini de alıyoruz
                    };
                    const div = document.createElement('div');
                    div.className = 'api-result-item';
                    div.innerHTML = `<p class="title">${bookData.title}</p><p class="author">${bookData.author}</p>`;
                    div.onclick = () => fillFormWithGoogleData(bookData);
                    apiResultsDiv.appendChild(div);
                });
            } catch (error) { console.error("API Hatası:", error); apiResultsDiv.classList.add('hidden'); }
        };

        const fillFormWithGoogleData = (bookData) => {
            const form = document.getElementById('book-form');
            if(!form) return;
            form.title.value = bookData.title;
            form.author.value = bookData.author;
            form.publisher.value = bookData.publisher;
            form.summary.value = bookData.summary; // Özeti gizli input'a yaz
            document.getElementById('api-results').classList.add('hidden');
        };

        const handleFetchSummary = async (book, button) => {
            button.disabled = true; button.textContent = 'Getiriliyor...';
            try {
                const query = `${book.title} ${book.author}`;
                const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=1&printType=books`);
                const data = await res.json();
                if (data.items && data.items[0].volumeInfo.description) {
                    const summary = data.items[0].volumeInfo.description;
                    await getBooksCollection().doc(book.id).update({ summary: summary });
                    showToast('Özet başarıyla getirildi.', 'success');
                    renderDetailsModal({ ...book, summary: summary }); // Modalı yeni veriyle yenile
                } else {
                    showToast('Bu kitap için özet bulunamadı.', 'error');
                    button.disabled = false; button.textContent = 'Özet Getir';
                }
            } catch (error) {
                console.error('Özet getirme hatası:', error);
                showToast('Özet getirilirken bir hata oluştu.', 'error');
                button.disabled = false; button.textContent = 'Özet Getir';
            }
        };

        // --- DETAY MODALI ---
        const renderDetailsModal = (book) => {
            const statusColors = { 'Okunacak': 'var(--secondary-text)', 'Okunuyor': 'var(--accent-1)', 'Okundu': 'var(--success-color)', 'Ödünç Verildi': 'var(--accent-2)' };
            const statusText = book.status === 'Ödünç Verildi' ? `${book.status} (${book.lentTo || 'Bilinmiyor'})` : book.status;
            
            let summaryHTML = `
                <div id="summary-section">
                    <h3>Kitap Özeti</h3>`;
            if (book.summary) {
                summaryHTML += `<p>${book.summary}</p>`;
            } else {
                summaryHTML += `<p>Bu kitap için henüz bir özet eklenmemiş.</p>
                                <button class="btn-fetch-summary">Google Kitaplar'dan Özet Getir</button>`;
            }
            summaryHTML += `</div>`;

            const content = `
                <div class="details-grid">
                    <div class="details-cover"><img src="${(book.coverUrl || '').replace('http://', 'https://') || `https://via.placeholder.com/200x300/e2e8f0/718096?text=Kapak`}" alt="${book.title}"></div>
                    <div>
                        <div class="details-info-grid">
                            <div class="details-label">Yazar</div> <div>${book.author}</div>
                            <div class="details-label">Puan</div> <div><span class="book-rating">${getStarRating(book.rating)}</span></div>
                            <div class="details-label">Durum</div> <div><span class="details-status" style="background-color:${statusColors[book.status] || '#ccc'}">${statusText}</span></div>
                            ${book.startDate ? `<div class="details-label">Başlama</div> <div>${book.startDate}</div>` : ''}
                            ${book.finishDate ? `<div class="details-label">Bitirme</div> <div>${book.finishDate}</div>` : ''}
                        </div>
                    </div>
                </div>
                ${summaryHTML}
                <div id="notes-section"></div>
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; flex-wrap:wrap; justify-content:flex-end;">
                    <button class="btn-edit">Düzenle</button>
                    ${book.status !== 'Ödünç Verildi' ? '<button class="btn-lend">Ödünç Ver</button>' : '<button class="btn-return">Geri Al</button>'}
                    <button class="btn-delete" style="background:var(--danger-color);">Sil</button>
                </div>`;
            openModal(content, book.title, 'var(--accent-1)');
            
            const modalContent = ui.modalContainer.querySelector('.modal-content');
            modalContent.querySelector('.btn-edit').onclick = () => renderBookFormModal(book);
            modalContent.querySelector('.btn-delete').onclick = async (e) => { e.target.disabled = true; if(confirm('Bu kitabı silmek istediğinize emin misiniz?')){ closeModal(); await getBooksCollection().doc(book.id).delete(); showToast('Kitap silindi.'); } else { e.target.disabled = false; }};
            
            const fetchSummaryBtn = modalContent.querySelector('.btn-fetch-summary');
            if (fetchSummaryBtn) {
                fetchSummaryBtn.onclick = (e) => handleFetchSummary(book, e.target);
            }
            // Diğer butonlar ve notlar...
        };
        
        // --- İSTATİSTİK MODALI ---
        const renderStatsModal = () => {
            if (allBooks.length === 0) { showToast("Gösterilecek istatistik için henüz kitap eklenmemiş.", "error"); return; }
            const totalBooks = allBooks.length;
            const statusCounts = { 'Okundu': 0, 'Okunuyor': 0, 'Okunacak': 0, 'Ödünç Verildi': 0 };
            allBooks.forEach(book => {
                if (book.status && statusCounts.hasOwnProperty(book.status)) statusCounts[book.status]++;
            });

            const content = `<div class="stats-grid">
                <div class="stat-card"><h3>${totalBooks}</h3><p>Toplam Kitap</p></div>
                <div class="stat-card"><h3>${statusCounts['Okundu']}</h3><p>Okunmuş</p></div>
                <div class="stat-card"><h3>${statusCounts['Okunuyor']}</h3><p>Okunuyor</p></div>
                <div class="stat-card"><h3>${statusCounts['Okunacak']}</h3><p>Okunacak</p></div>
                <div class="stat-card"><h3>${statusCounts['Ödünç Verildi']}</h3><p>Ödünç Verildi</p></div>
            </div>`;
            openModal(content, "Kütüphane İstatistikleri", 'var(--accent-2)');
        };

        // --- AYARLAR MODALI ve İŞLEVLERİ ---
        const renderSettingsModal = () => {
            const currentTheme = document.body.dataset.theme;
            const content = `
                <div class="settings-section">
                    <h3>Tema Seçimi</h3>
                    <div class="form-group">
                        <select id="theme-selector">
                            <option value="default" ${currentTheme === 'default' ? 'selected' : ''}>Varsayılan (Domates)</option>
                            <option value="ocean" ${currentTheme === 'ocean' ? 'selected' : ''}>Okyanus</option>
                            <option value="forest" ${currentTheme === 'forest' ? 'selected' : ''}>Orman</option>
                            <option value="dusk" ${currentTheme === 'dusk' ? 'selected' : ''}>Alacakaranlık (Koyu)</option>
                        </select>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>Veri Yönetimi</h3>
                    <div class="settings-controls">
                        <button id="import-btn-modal">İçe Aktar (.json)</button>
                        <button id="export-btn-modal">Dışa Aktar (.json)</button>
                        <button id="deduplicate-btn" style="background-color: var(--danger-color);">Aynı Kitapları Temizle</button>
                    </div>
                </div>`;
            openModal(content, "Ayarlar", 'var(--accent-3)');
            
            document.getElementById('theme-selector').onchange = (e) => applyTheme(e.target.value);
            document.getElementById('import-btn-modal').onclick = () => ui.importFile.click();
            document.getElementById('export-btn-modal').onclick = handleExport;
            document.getElementById('deduplicate-btn').onclick = handleDeduplication;
        };

        const handleExport = () => { /* ... (no changes) ... */ };
        const handleImport = (event) => { /* ... (no changes) ... */ };

        const handleDeduplication = async () => {
            if (!confirm("Aynı isim ve yazara sahip kitapların eski kopyaları silinecektir. Bu işlem geri alınamaz. Onaylıyor musunuz?")) return;

            const seen = new Map();
            const duplicatesToDelete = [];

            // Kitapları eklenme tarihine göre sıralayarak ilk eklenenin kalmasını sağlıyoruz
            const sortedBooks = [...allBooks].sort((a,b) => (a.dateAdded?.toMillis() || 0) - (b.dateAdded?.toMillis() || 0));

            for (const book of sortedBooks) {
                const key = `${(book.title || '').trim().toLowerCase()}-${(book.author || '').trim().toLowerCase()}`;
                if (seen.has(key)) {
                    duplicatesToDelete.push(book.id);
                } else {
                    seen.set(key, book.id);
                }
            }

            if (duplicatesToDelete.length === 0) {
                showToast("Yinelenen kitap bulunamadı.", "success");
                return;
            }

            try {
                const batch = db.batch();
                duplicatesToDelete.forEach(id => {
                    batch.delete(getBooksCollection().doc(id));
                });
                await batch.commit();
                showToast(`${duplicatesToDelete.length} adet yinelenen kitap silindi.`, "success");
                closeModal(); // Ayarlar modalını kapat
            } catch (error) {
                console.error("Yinelenenleri silme hatası:", error);
                showToast("Kitaplar silinirken bir hata oluştu.", "error");
            }
        };

        // --- OLAY DİNLEYİCİLERİ ---
        document.getElementById('add-book-btn').onclick = () => renderBookFormModal();
        document.getElementById('show-stats-btn').onclick = renderStatsModal;
        document.getElementById('settings-btn').onclick = renderSettingsModal;
        ui.searchInput.addEventListener('input', renderBooks);
        ui.filterStatus.addEventListener('change', renderBooks);
        ui.sortBy.addEventListener('change', renderBooks);
        ui.importFile.onchange = handleImport;
    });
    </script>
</body>
</html>
