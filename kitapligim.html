<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benim Zarif Kütüphanem</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #fdfaf6;
            --card-bg: #FFFFFF;
            --primary-text: #4a4a4a;
            --secondary-text: #9b9b9b;
            --accent-1: #d1a3a3;
            --accent-2: #8a9a8f;
            --accent-3: #e8c59a;
            --danger-color: #c97b7b;
            --font-heading: 'Lora', serif;
            --font-body: 'Montserrat', sans-serif;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 15px rgba(0,0,0,0.07);
        }
        *, *::before, *::after { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-body);
            margin: 0;
            background-color: var(--bg-color);
            color: var(--primary-text);
            font-size: 16px;
            line-height: 1.6;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e8c59a' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .container { max-width: 1200px; margin: 20px auto; padding: 15px; }
        h1, h2, h3 { font-family: var(--font-heading); margin-top: 0; color: var(--primary-text); font-weight: 600; }
        header { text-align: center; padding: 1rem; margin-bottom: 20px; }
        header h1 { color: var(--primary-text); font-size: 2.8em; margin: 0; font-style: italic; }
        .controls-bar { padding: 20px; background-color: rgba(255,255,255,0.8); backdrop-filter: blur(12px); border-radius: 20px; box-shadow: var(--shadow-md); display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.2); }
        .controls-group { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        button { background-color: var(--accent-1); color: white; padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer; font-size: 0.95em; font-weight: 500; transition: all 0.3s ease; box-shadow: var(--shadow-sm); }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        button:disabled { background-color: #ccc; cursor: not-allowed; transform: none; box-shadow: var(--shadow-sm); }
        .controls-bar input[type="text"], .controls-bar select { padding: 12px 15px; border: 1px solid #e0e0e0; border-radius: 12px; background-color: #fff; font-size: 1em; }
        .list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 30px; min-height: 300px; }
        .book-card { background-color: var(--card-bg); border-radius: 16px; box-shadow: var(--shadow-md); overflow: hidden; display: flex; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; border-left: 6px solid; }
        .book-card:hover { transform: translateY(-6px); box-shadow: 0 8px 25px rgba(61,64,91,0.12); }
        .book-card:nth-child(4n+1) { border-left-color: var(--accent-1); }
        .book-card:nth-child(4n+2) { border-left-color: var(--accent-2); }
        .book-card:nth-child(4n+3) { border-left-color: var(--accent-3); }
        .book-card:nth-child(4n+4) { border-left-color: var(--primary-text); }
        .card-cover img { width: 110px; height: 165px; object-fit: cover; display: block; }
        .card-info { padding: 20px; display: flex; flex-direction: column; justify-content: center; flex-grow: 1; }
        .card-info h3 { margin: 0 0 5px 0; font-size: 1.2em; }
        .card-info p { margin: 2px 0; font-size: 0.9em; color: var(--secondary-text); }
        .book-rating { color: var(--accent-3); font-size: 1.2em; margin-top: 10px !important; }
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 20px; padding: 30px 0; }
        #page-indicator { font-weight: 500; color: var(--secondary-text); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow-y: auto; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(8px); animation: fadeIn 0.3s; }
        .modal-content { background-color: var(--card-bg); margin: 5% auto; padding: 35px; border-radius: 20px; width: 90%; max-width: 650px; position: relative; box-shadow: 0 5px 25px rgba(0,0,0,0.1); animation: slideIn 0.4s; }
        .close-button { color: #aaa; background: none; border: none; position: absolute; top: 15px; right: 25px; font-size: 32px; font-weight: bold; cursor: pointer; padding: 0; line-height: 1; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9em; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; background-color: #fdfdfd; box-sizing: border-box; }
        #api-results { position: absolute; background: white; width: 100%; border: 1px solid #ddd; border-top: none; border-radius: 0 0 12px 12px; z-index: 10; max-height: 250px; overflow-y: auto; }
        .hidden { display: none; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--primary-text); color: white; padding: 12px 25px; border-radius: 12px; z-index: 2000; opacity: 0; transition: opacity 0.5s, transform 0.5s; box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .details-grid { display: grid; grid-template-columns: 150px 1fr; gap: 25px; align-items: start; }
        .details-info-grid { display: grid; grid-template-columns: auto 1fr; gap: 10px 15px; align-items: center; }
        .details-label { font-weight: 500; color: var(--secondary-text); }
        .details-status { padding: 5px 12px; border-radius: 20px; font-size: 0.9em; font-weight: 500; color: white; text-align: center;}
        .note-item { background: #fafafa; padding: 12px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s; border-left: 3px solid var(--accent-3); }
        .note-item:hover { background: #f0f0f0; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; text-align: center; }
        .stat-item h3 { font-size: 2.5em; color: var(--accent-1); margin: 0; }
        .stat-item p { margin: 5px 0 0 0; color: var(--secondary-text); }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes slideIn { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
    </style>
</head>
<body>

    <div id="login-screen" style="text-align: center; padding-top: 20vh;">
        <header><h1>Benim Zarif Kütüphanem</h1></header>
        <button id="login-btn">Google ile Giriş Yap</button>
    </div>

    <div id="main-app" class="hidden">
        <header>
            <h1>Benim Zarif Kütüphanem</h1>
            <div class="user-profile" style="font-weight: 500;">
                <span id="user-display-name"></span>
                <button id="logout-btn" style="background:var(--accent-1); margin-left:15px; font-size:0.8em; padding:8px 12px;">Çıkış Yap</button>
            </div>
        </header>
        <div class="container">
            <main id="library-view">
                <div class="controls-bar">
                    <div class="controls-group">
                        <button id="add-book-btn" style="background-color: var(--accent-2);">Yeni Kitap Ekle</button>
                        <input type="text" id="search-input" placeholder="Kütüphanede ara...">
                        <select id="filter-status">
                            <option value="Tümü">Filtrele: Tümü</option><option value="Okunacak">Okunacak</option><option value="Okunuyor">Okunuyor</option><option value="Okundu">Okundu</option><option value="Ödünç Verildi">Ödünç Verildi</option>
                        </select>
                    </div>
                    <div class="controls-group">
                        <button id="stats-btn" style="background-color: var(--accent-3);">İstatistikler</button>
                        <button id="import-btn">İçe Aktar</button>
                        <button id="export-btn">Dışa Aktar</button>
                        <input type="file" id="import-file" class="hidden" accept=".json">
                    </div>
                </div>
                <div class="list-container" id="book-list"></div>
                <div id="pagination-controls" class="pagination-controls">
                    <button id="prev-page-btn" disabled>Önceki</button>
                    <span id="page-indicator">Sayfa 1</span>
                    <button id="next-page-btn">Sonraki</button>
                </div>
            </main>
        </div>
        <div id="modal-container"></div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase ve Global Değişkenler ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const FieldValue = firebase.firestore.FieldValue;

        let currentUser = null;
        
        const BOOKS_PER_PAGE = 20;
        let currentPage = 1;
        let lastVisibleDoc = null;
        let firstVisibleDoc = null;
        
        const ui = {
            loginScreen: document.getElementById('login-screen'), mainApp: document.getElementById('main-app'),
            loginBtn: document.getElementById('login-btn'), logoutBtn: document.getElementById('logout-btn'),
            userDisplayName: document.getElementById('user-display-name'), bookList: document.getElementById('book-list'),
            searchInput: document.getElementById('search-input'), filterStatus: document.getElementById('filter-status'),
            modalContainer: document.getElementById('modal-container'),
            addBookBtn: document.getElementById('add-book-btn'), statsBtn: document.getElementById('stats-btn'),
            importBtn: document.getElementById('import-btn'), exportBtn: document.getElementById('export-btn'),
            importFile: document.getElementById('import-file'),
            prevPageBtn: document.getElementById('prev-page-btn'), nextPageBtn: document.getElementById('next-page-btn'),
            pageIndicator: document.getElementById('page-indicator')
        };
        
        const BOOK_STATUSES = {
            TO_READ: 'Okunacak',
            READING: 'Okunuyor',
            READ: 'Okundu',
            LENT: 'Ödünç Verildi'
        };

        // --- Kimlik Doğrulama ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                ui.loginScreen.classList.add('hidden');
                ui.mainApp.classList.remove('hidden');
                ui.userDisplayName.textContent = `Hoş geldin, ${user.displayName.split(' ')[0]}`;
                loadBooks();
            } else {
                currentUser = null;
                ui.loginScreen.classList.remove('hidden');
                ui.mainApp.classList.add('hidden');
            }
        });
        ui.loginBtn.onclick = () => { const p = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(p).catch(e => console.error("Giriş Hatası:", e)); };
        ui.logoutBtn.onclick = () => auth.signOut();

        // --- Veri Yolu ---
        const getBooksCollection = () => db.collection('users').doc(currentUser.uid).collection('books');

        // --- Ana Veri Yükleme Fonksiyonu (Sayfalamalı) ---
        const loadBooks = async (direction = 'first') => {
            ui.bookList.innerHTML = `<p style='text-align:center; color:var(--secondary-text); grid-column: 1 / -1;'>Kitaplar yükleniyor...</p>`;
            let query = getBooksCollection().orderBy('title_lowercase', 'asc');

            const statusFilter = ui.filterStatus.value;
            if (statusFilter !== 'Tümü') {
                query = query.where('status', '==', statusFilter);
            }

            const searchTerm = ui.searchInput.value.toLowerCase().trim();
            if (searchTerm) {
                query = query.where('title_lowercase', '>=', searchTerm)
                             .where('title_lowercase', '<=', searchTerm + '\uf8ff');
            }

            if (direction === 'next' && lastVisibleDoc) {
                query = query.startAfter(lastVisibleDoc).limit(BOOKS_PER_PAGE);
            } else if (direction === 'prev' && firstVisibleDoc) {
                query = query.endBefore(firstVisibleDoc).limitToLast(BOOKS_PER_PAGE);
            } else {
                currentPage = 1;
                lastVisibleDoc = null;
                firstVisibleDoc = null;
                query = query.limit(BOOKS_PER_PAGE);
            }

            try {
                const snapshot = await query.get();
                const books = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (!snapshot.empty) {
                    firstVisibleDoc = snapshot.docs[0];
                    lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
                }

                renderBooks(books);
                updatePaginationControls(snapshot.size);
            } catch (error) {
                console.error("Kitap yükleme hatası:", error);
                showToast("Kitaplar yüklenemedi: " + error.message, "error");
                ui.bookList.innerHTML = `<p style='text-align:center; color:var(--danger-color); grid-column: 1 / -1;'>Kitaplar yüklenirken bir hata oluştu.</p>`;
            }
        };

        const updatePaginationControls = (currentSize) => {
            ui.prevPageBtn.disabled = currentPage === 1;
            ui.nextPageBtn.disabled = currentSize < BOOKS_PER_PAGE;
            ui.pageIndicator.textContent = `Sayfa ${currentPage}`;
        };

        // --- Arayüz Çizim Fonksiyonları ---
        const renderBooks = (booksToRender) => {
            ui.bookList.innerHTML = '';
            if (booksToRender.length === 0) {
                ui.bookList.innerHTML = `<p style='text-align:center; color:var(--secondary-text); grid-column: 1 / -1;'>Bu kriterlere uyan kitap bulunamadı.</p>`;
            } else {
                booksToRender.forEach(book => ui.bookList.appendChild(createBookCard(book)));
            }
        };

        const getStarRating = (r = 0) => '★'.repeat(r) + '☆'.repeat(5 - r);

        const createBookCard = (book) => {
            const card = document.createElement('div');
            card.className = `book-card`;
            card.dataset.id = book.id;
            const coverUrl = (book.coverUrl || '').replace('http://', 'https://');
            const placeholder = 'https://via.placeholder.com/110x165/fdfaf6/9b9b9b?text=Kapak';
            card.innerHTML = `<div class="card-cover"><img src="${coverUrl || placeholder}" alt="${book.title}" loading="lazy"></div>
                              <div class="card-info"><h3>${book.title}</h3><p>${book.author}</p><p class="book-rating">${getStarRating(book.rating)}</p></div>`;
            card.onclick = () => renderDetailsModal(book);
            return card;
        };

        // --- Modal & Geri Bildirim Fonksiyonları ---
        const openModal = (content) => { 
            ui.modalContainer.innerHTML = `<div class="modal" style="display:flex; align-items:center; justify-content:center;"><div class="modal-content">${content}</div></div>`; 
            ui.modalContainer.querySelector('.close-button')?.addEventListener('click', closeModal); 
        };
        const closeModal = () => { const modal = ui.modalContainer.querySelector('.modal'); if (modal) modal.remove(); };
        window.onclick = e => { if (e.target.classList.contains('modal')) closeModal(); };
        
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = 'toast';
            if (type === 'error') toast.style.backgroundColor = 'var(--danger-color)';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => document.body.removeChild(toast), 500);
                }, 3000);
            }, 100);
        };

        // --- CRUD ve Diğer Özellik Fonksiyonları ---
        const renderDetailsModal = (book) => {
            const statusColors = { [BOOK_STATUSES.TO_READ]: '#a0aec0', [BOOK_STATUSES.READING]: 'var(--accent-1)', [BOOK_STATUSES.READ]: 'var(--accent-2)', [BOOK_STATUSES.LENT]: 'var(--accent-3)' };
            const statusText = book.status === BOOK_STATUSES.LENT ? `${book.status} (${book.lentTo || ''})` : book.status;
            const content = `<button type="button" class="close-button" aria-label="Kapat">&times;</button>
                <h2>${book.title}</h2>
                <div class="details-grid">
                    <img src="${(book.coverUrl || '').replace('http://', 'https://') || 'https://via.placeholder.com/150x220'}" alt="${book.title}" style="width:150px; height:220px; object-fit:cover; border-radius:12px;">
                    <div class="details-info-grid">
                        <div class="details-label">Yazar</div> <div>${book.author}</div>
                        <div class="details-label">Puan</div> <div><span class="book-rating">${getStarRating(book.rating)}</span></div>
                        <div class="details-label">Durum</div> <div><span class="details-status" style="background-color:${statusColors[book.status] || '#ccc'}">${statusText}</span></div>
                        ${book.startDate ? `<div class="details-label">Başlama</div> <div>${book.startDate}</div>` : ''}
                        ${book.finishDate ? `<div class="details-label">Bitirme</div> <div>${book.finishDate}</div>` : ''}
                    </div>
                </div>
                <div id="notes-section" style="margin-top: 25px;"></div>
                <div style="margin-top: 25px; border-top: 1px solid #eee; padding-top: 20px; display: flex; gap: 10px; flex-wrap:wrap;">
                    <button class="btn-edit">Düzenle</button>
                    ${book.status !== BOOK_STATUSES.LENT ? '<button class="btn-lend">Ödünç Ver</button>' : '<button class="btn-return">Geri Al</button>'}
                    <button class="btn-delete" style="background:var(--danger-color);">Sil</button>
                </div>`;
            openModal(content);
            const modalContent = ui.modalContainer.querySelector('.modal-content');
            modalContent.querySelector('.btn-edit').onclick = () => renderBookFormModal(book);
            modalContent.querySelector('.btn-delete').onclick = async (e) => { 
                e.target.disabled = true; 
                if(confirm('Bu kitabı silmek istediğinize emin misiniz?')){ 
                    closeModal(); 
                    await getBooksCollection().doc(book.id).delete(); 
                    showToast('Kitap silindi.'); 
                    loadBooks();
                } else { 
                    e.target.disabled = false; 
                }
            };
            const lendBtn = modalContent.querySelector('.btn-lend');
            if (lendBtn) lendBtn.onclick = () => handleLendBook(book);
            const returnBtn = modalContent.querySelector('.btn-return');
            if (returnBtn) returnBtn.onclick = () => handleReturnBook(book);
            renderNotes(book);
        };

        const renderBookFormModal = (book = {}) => {
            const isEditing = !!book.id;
            const title = isEditing ? 'Kitabı Düzenle' : 'Yeni Kitap Ekle';
            const content = `<button type="button" class="close-button" aria-label="Kapat">&times;</button><h2>${title}</h2>
                <form id="book-form">
                    <div class="form-group" style="position:relative;">
                        <label for="title">Kitap Adı</label>
                        <input type="text" id="title" value="${book.title || ''}" required autocomplete="off">
                        <div id="api-results"></div>
                    </div>
                    <div class="form-group"><label for="author">Yazar</label><input type="text" id="author" value="${book.author || ''}" required></div>
                    <div class="form-group"><label for="publisher">Yayınevi</label><input type="text" id="publisher" value="${book.publisher || ''}"></div>
                    <div class="form-group">
                        <label for="cover-url">Kapak Fotoğrafı URL</label>
                        <input type="text" id="cover-url" value="${book.coverUrl || ''}">
                        <div style="display:flex; gap:10px; margin-top: 8px;">
                            <button type="button" class="btn-g-search">Google'da Görsel Ara</button>
                            <label for="cover-file-input" style="background-color: var(--accent-3); display:inline-block; padding:8px 15px; border-radius:12px; cursor:pointer; font-size:0.9em; color:white;">Veya Yükle</label>
                        </div>
                        <input type="file" id="cover-file-input" class="hidden" accept="image/*">
                        <img id="cover-preview" class="${book.coverUrl ? '' : 'hidden'}" src="${book.coverUrl || ''}" alt="Önizleme" style="max-width:100px; max-height:150px; margin-top:10px; border-radius:8px; border:1px solid #ddd;">
                    </div>
                    <div class="form-group"><label for="status">Durum</label><select id="status"></select></div>
                    <div class="form-group hidden" id="date-fields"></div>
                    <div class="form-group"><label for="rating">Puan (0-5)</label><input type="number" id="rating" min="0" max="5" step="1" value="${book.rating || 0}"></div>
                    <button type="submit">Kaydet</button>
                </form>`;
            openModal(content);
            const form = document.getElementById('book-form');
            const statusSelect = form.querySelector('#status');
            [BOOK_STATUSES.TO_READ, BOOK_STATUSES.READING, BOOK_STATUSES.READ].forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; if(book.status===s) o.selected=true; statusSelect.appendChild(o); });
            const updateDateFields = () => {
                const fieldsDiv = form.querySelector('#date-fields');
                fieldsDiv.innerHTML = '';
                if (statusSelect.value === BOOK_STATUSES.READING) fieldsDiv.innerHTML = `<label for="start-date">Başlama Tarihi</label><input type="date" id="start-date" value="${book.startDate || ''}">`;
                else if (statusSelect.value === BOOK_STATUSES.READ) fieldsDiv.innerHTML = `<label for="finish-date">Bitirme Tarihi</label><input type="date" id="finish-date" value="${book.finishDate || ''}">`;
                fieldsDiv.classList.toggle('hidden', statusSelect.value === BOOK_STATUSES.TO_READ || !statusSelect.value);
            };
            statusSelect.onchange = updateDateFields; updateDateFields();
            form.onsubmit = (e) => handleBookFormSubmit(e, book);
            let searchTimeout;
            form.querySelector('#title').addEventListener('keyup', (e) => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => searchGoogleBooks(e.target.value), 400); });
            form.querySelector('.btn-g-search').onclick = () => { const query = `${form.title.value} ${form.author.value} kitap kapağı`; window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`, '_blank'); };
            form.querySelector('#cover-file-input').onchange = (e) => handleCoverFileUpload(e, form);
            form.querySelector('#cover-url').addEventListener('input', e => {
                const preview = form.querySelector('#cover-preview');
                preview.src = e.target.value.trim().replace('http://', 'https://');
                preview.classList.toggle('hidden', !e.target.value.trim());
            });
        };

        const handleBookFormSubmit = async (e, existingBook) => {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true; submitButton.textContent = "Kaydediliyor...";
            
            const bookData = {
                title: form.title.value.trim(),
                title_lowercase: form.title.value.trim().toLowerCase(),
                author: form.author.value.trim(),
                publisher: form.publisher.value.trim(),
                coverUrl: form['cover-url'].value.trim(),
                status: form.status.value,
                rating: parseInt(form.rating.value) || 0,
                startDate: form['start-date']?.value || '',
                finishDate: form['finish-date']?.value || ''
            };

            try {
                if (existingBook.id) {
                    await getBooksCollection().doc(existingBook.id).update(bookData);
                    showToast('Kitap güncellendi.');
                } else {
                    await getBooksCollection().add({ ...bookData, notes: [], dateAdded: FieldValue.serverTimestamp() });
                    showToast('Kitap eklendi.');
                }
                closeModal();
                loadBooks(); // Listeyi yenile
            } catch (error) { console.error("Kitap kaydetme hatası: ", error); showToast('Kitap kaydedilemedi.','error'); }
            finally { submitButton.disabled = false; submitButton.textContent = "Kaydet"; }
        };

        const handleLendBook = async (book) => {
            const lentTo = prompt("Bu kitabı kime ödünç verdiniz?");
            if (lentTo && lentTo.trim() !== '') {
                try {
                    await getBooksCollection().doc(book.id).update({
                        status: BOOK_STATUSES.LENT,
                        lentTo: lentTo.trim(),
                        previousStatus: book.status
                    });
                    showToast(`'${book.title}' kitabı ${lentTo}'a ödünç verildi.`);
                    closeModal();
                    loadBooks();
                } catch (error) { showToast('İşlem başarısız oldu.', 'error'); }
            }
        };

        const handleReturnBook = async (book) => {
            if (confirm(`'${book.title}' kitabını geri almak istediğinize emin misiniz?`)) {
                try {
                    await getBooksCollection().doc(book.id).update({
                        status: book.previousStatus || BOOK_STATUSES.TO_READ,
                        lentTo: FieldValue.delete(),
                        previousStatus: FieldValue.delete()
                    });
                    showToast('Kitap kütüphaneye geri alındı.');
                    closeModal();
                    loadBooks();
                } catch (error) { showToast('İşlem başarısız oldu.', 'error');}
            }
        };

        // --- Notlar Fonksiyonları ---
        const renderNotes = (book) => {
            const notesSection = document.getElementById('notes-section');
            if(!notesSection) return;
            notesSection.innerHTML = `<h3>Kitap Notları</h3><div id="notes-list"></div>
                <form id="note-form" style="margin-top:15px;"><div class="form-group"><textarea id="new-note-text" placeholder="Yeni bir not ekle..." rows="3" required></textarea><button type="submit" style="width:auto; float:right; margin-top:10px;">Not Ekle</button></div></form>`;
            const notesListDiv = document.getElementById('notes-list');
            notesListDiv.innerHTML = '';
            const sortedNotes = (book.notes || []).sort((a,b) => b.id - a.id);
            if (sortedNotes.length > 0) {
                sortedNotes.forEach(note => {
                    const noteDiv = document.createElement('div');
                    noteDiv.className = 'note-item';
                    noteDiv.innerHTML = `<p style="margin:0;">${note.text.replace(/\n/g, '<br>')}</p><small style="color:var(--secondary-text)">${new Date(note.id).toLocaleString('tr-TR')}</small>`;
                    noteDiv.onclick = () => renderNoteForm(book, note);
                    notesListDiv.appendChild(noteDiv);
                });
            } else {
                notesListDiv.innerHTML = '<p style="color:var(--secondary-text); text-align:center;">Henüz not eklenmemiş.</p>';
            }
            document.getElementById('note-form').onsubmit = (e) => { e.preventDefault(); handleAddOrUpdateNote(book, null, e.target['new-note-text'].value); e.target.reset(); };
        };
        
        const renderNoteForm = (book, note = {}) => {
            const isEditing = !!note.id;
            const content = `<button type="button" class="close-button" aria-label="Kapat">&times;</button><h2>Notu ${isEditing ? 'Düzenle': 'Ekle'}</h2>
                <form id="edit-note-form"><div class="form-group"><textarea id="edit-note-text" rows="8" required>${note.text || ''}</textarea></div>
                <div style="display:flex; justify-content:space-between;">
                ${isEditing ? '<button type="button" class="btn-delete-note" style="background:var(--danger-color)">Sil</button>' : '<div></div>'}
                <button type="submit">Kaydet</button></div></form>`;
            openModal(content);
            const form = document.getElementById('edit-note-form');
            form.onsubmit = (e) => { e.preventDefault(); handleAddOrUpdateNote(book, note.id, form.querySelector('#edit-note-text').value); };
            const deleteBtn = form.querySelector('.btn-delete-note');
            if(deleteBtn) deleteBtn.onclick = () => { if(confirm('Notu silmek istediğinize emin misiniz?')) handleAddOrUpdateNote(book, note.id, null); };
        };

        const handleAddOrUpdateNote = async (book, noteId, text) => {
            let currentNotes = book.notes || [];
            if (text === null && noteId) { // Silme
                currentNotes = currentNotes.filter(n => n.id !== noteId);
            } else if (noteId) { // Düzenleme
                const noteIndex = currentNotes.findIndex(n => n.id === noteId);
                if (noteIndex > -1) currentNotes[noteIndex].text = text.trim();
            } else { // Ekleme
                currentNotes.push({ id: Date.now(), text: text.trim() });
            }
            await getBooksCollection().doc(book.id).update({ notes: currentNotes });
            
            const updatedBookInModal = { ...book, notes: currentNotes };
            // Modalı kapatıp açmak yerine sadece notlar bölümünü yeniden çiz
            const notesSection = document.getElementById('notes-section');
            if(notesSection) {
                renderNotes(updatedBookInModal);
                closeModal(); // Not düzenleme modalını kapat
                renderDetailsModal(updatedBookInModal); // Detay modalını güncel notlarla tekrar aç
            } else {
                closeModal();
            }
        };

        // --- Harici API ve Dosya İşlemleri ---
        const searchGoogleBooks = async (query) => {
             const apiResultsDiv = document.getElementById('api-results');
            if (!apiResultsDiv || query.length < 3) { if(apiResultsDiv) apiResultsDiv.innerHTML = ''; return; }
            apiResultsDiv.innerHTML = '<div style="padding:10px; text-align:center;">Aranıyor...</div>';
            try {
                const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=5&printType=books`);
                const data = await res.json();
                apiResultsDiv.innerHTML = '';
                if (!data.items) return;
                data.items.forEach(item => {
                    const info = item.volumeInfo;
                    if(!info.title || !info.authors) return;
                    const div = document.createElement('div');
                    div.style.padding = '10px'; div.style.cursor = 'pointer';
                    div.onmouseover = () => div.style.backgroundColor = '#f0f0f0';
                    div.onmouseout = () => div.style.backgroundColor = 'transparent';
                    div.innerHTML = `<p style="margin:0; font-weight:bold;">${info.title}</p><p style="margin:0; font-size:0.9em;">${info.authors.join(', ')}</p>`;
                    div.onclick = () => {
                        const form = document.getElementById('book-form');
                        form.title.value = info.title || ''; form.author.value = info.authors?.join(', ') || ''; form.publisher.value = info.publisher || '';
                        const thumb = (info.imageLinks?.thumbnail || info.imageLinks?.smallThumbnail || '').replace('http://', 'https://');
                        form.querySelector('#cover-url').value = thumb;
                        form.querySelector('#cover-preview').src = thumb;
                        form.querySelector('#cover-preview').classList.remove('hidden');
                        apiResultsDiv.innerHTML = '';
                    };
                    apiResultsDiv.appendChild(div);
                });
            } catch (error) { console.error("API Hatası:", error); }
        };

        const handleCoverFileUpload = async (e, form) => {
            const file = e.target.files[0];
            if (!file) return;
            const uploadButton = form.querySelector('button[type="submit"]');
            uploadButton.disabled = true;
            uploadButton.textContent = "Kapak Yükleniyor...";
            try {
                const filePath = `${currentUser.uid}/${Date.now()}-${file.name}`;
                const fileSnapshot = await storage.ref(filePath).put(file);
                const url = await fileSnapshot.ref.getDownloadURL();
                form.querySelector('#cover-url').value = url;
                const preview = form.querySelector('#cover-preview');
                preview.src = url;
                preview.classList.remove('hidden');
                showToast("Kapak yüklendi.");
            } catch (error) {
                showToast("Kapak yüklenemedi.", "error");
            } finally {
                uploadButton.disabled = false;
                uploadButton.textContent = "Kaydet";
            }
        };
        
        const renderStatsModal = (allBooks) => {
            const content = `<button type="button" class="close-button" aria-label="Kapat">&times;</button>
                <h2>Kütüphane İstatistikleri</h2>
                <div class="stats-grid">
                    <div class="stat-item"><h3>${allBooks.length}</h3><p>Toplam Kitap</p></div>
                    <div class="stat-item"><h3>${allBooks.filter(b => b.status === BOOK_STATUSES.READ).length}</h3><p>Okunmuş</p></div>
                    <div class="stat-item"><h3>${allBooks.filter(b => b.status === BOOK_STATUSES.READING).length}</h3><p>Okunuyor</p></div>
                    <div class="stat-item"><h3>${allBooks.filter(b => b.status === BOOK_STATUSES.LENT).length}</h3><p>Ödünç Verilen</p></div>
                    <div class="stat-item"><h3>${allBooks.filter(b => b.status === BOOK_STATUSES.TO_READ).length}</h3><p>Okunacak</p></div>
                </div>`;
            openModal(content);
        };

        const exportLibrary = (allBooks) => {
            if (allBooks.length === 0) {
                showToast('Dışa aktarılacak kitap bulunmuyor.', 'error');
                return;
            }
            const booksToExport = allBooks.map(book => {
                const { id, dateAdded, title_lowercase, ...rest } = book;
                return rest;
            });
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(booksToExport, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `kutuphanem_yedeği_${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast('Kütüphane dışa aktarıldı.');
        };

        const importLibrary = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedBooks = JSON.parse(e.target.result);
                    if (!Array.isArray(importedBooks)) throw new Error("JSON formatı hatalı.");

                    if (confirm(`${importedBooks.length} kitap içe aktarılacak. Bu işlem geri alınamaz. Onaylıyor musunuz?`)) {
                        const batch = db.batch();
                        importedBooks.forEach(book => {
                            if (!book.title) return;
                            const newBookRef = getBooksCollection().doc();
                            batch.set(newBookRef, { 
                                ...book,
                                title_lowercase: book.title.toLowerCase(),
                                dateAdded: FieldValue.serverTimestamp() 
                            });
                        });
                        await batch.commit();
                        showToast(`${importedBooks.length} kitap başarıyla içe aktarıldı.`);
                        loadBooks();
                    }
                } catch (error) {
                    showToast('İçe aktarma başarısız: ' + error.message, 'error');
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        };

        // --- Event Listeners ---
        ui.addBookBtn.onclick = () => renderBookFormModal();
        
        let searchTimeout;
        ui.searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadBooks('first');
            }, 500);
        });
        ui.filterStatus.addEventListener('change', () => {
            loadBooks('first');
        });
        ui.nextPageBtn.onclick = () => { currentPage++; loadBooks('next'); };
        ui.prevPageBtn.onclick = () => { currentPage--; loadBooks('prev'); };
        ui.statsBtn.onclick = async () => {
            showToast("İstatistikler hesaplanıyor...");
            const allBooksSnapshot = await getBooksCollection().get();
            const allBooksData = allBooksSnapshot.docs.map(d => d.data());
            renderStatsModal(allBooksData);
        };
        ui.exportBtn.onclick = async () => {
            showToast("Tüm kitaplar dışa aktarma için hazırlanıyor...");
            const allBooksSnapshot = await getBooksCollection().orderBy('title_lowercase').get();
            const allBooksData = allBooksSnapshot.docs.map(d => ({id: d.id, ...d.data()}));
            exportLibrary(allBooksData);
        };
        ui.importBtn.onclick = () => ui.importFile.click();
        ui.importFile.onchange = importLibrary;
    });
    </script>
</body>
</html>
