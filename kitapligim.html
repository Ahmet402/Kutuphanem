<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benim Güzel Kütüphanem</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #F8F5F2; --card-bg: #FFFFFF; --primary-text: #403D39; --secondary-text: #74716C;
            --accent-color: #D4A276; --green-accent: #6D8B74; --pink-accent: #E1C4B8; --danger-color: #e74c3c;
            --font-heading: 'Lora', serif; --font-body: 'Montserrat', sans-serif;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: var(--font-body); margin: 0; background-color: var(--bg-color); color: var(--primary-text); font-size: 16px; line-height: 1.6; }
        .container { max-width: 1200px; margin: 20px auto; padding: 15px; }
        h1, h2, h3 { font-family: var(--font-heading); margin-top: 0; }
        header { text-align: center; padding: 1rem; margin-bottom: 20px; }
        header h1 { color: var(--primary-text); font-size: 2.5em; margin: 0; }
        nav { display: flex; justify-content: center; background-color: var(--card-bg); border-radius: 12px; padding: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .nav-button { flex: 1; padding: 12px 20px; border: none; background: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 500; color: var(--secondary-text); transition: all 0.3s; }
        .nav-button.active { background-color: var(--green-accent); color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stats-panel { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px; padding: 20px; margin-bottom: 25px; background-color: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .stat-item { text-align: center; }
        .stat-item h3 { margin: 0 0 5px 0; font-size: 2em; color: var(--green-accent); }
        .stat-item p { margin: 0; font-size: 0.9em; color: var(--secondary-text); }
        .controls-bar { padding: 15px; background-color: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        .top-controls, .bottom-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        button, .action-button { background-color: var(--green-accent); color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 500; transition: background-color 0.3s; }
        button:hover, .action-button:hover { background-color: #5a7462; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        .controls-bar select, .controls-bar input[type="text"] { padding: 12px; border: 1px solid #ddd; border-radius: 8px; background-color: var(--bg-color); min-width: 180px; }
        .list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .book-card, .wish-card { background-color: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; display: flex; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border-left: 5px solid transparent; }
        .book-card:hover, .wish-card:hover { transform: translateY(-5px); box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .status-card-okunacak { border-left-color: #a0aec0; }
        .status-card-okunuyor { border-left-color: var(--accent-color); }
        .status-card-okundu { border-left-color: var(--green-accent); }
        .status-card-odunc-verildi { border-left-color: var(--pink-accent); }
        .card-cover img { width: 100px; height: 150px; object-fit: cover; display: block; }
        .card-info { padding: 15px; display: flex; flex-direction: column; justify-content: center; flex-grow: 1; }
        .card-info h3 { margin: 0 0 5px 0; font-size: 1.1em; }
        .card-info p { margin: 2px 0; font-size: 0.9em; color: var(--secondary-text); }
        .book-rating { color: var(--accent-color); font-size: 1.1em; margin-top: 8px !important; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow-y: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); animation: fadeIn 0.3s; }
        .modal-content { background-color: var(--card-bg); margin: 5% auto; padding: 30px; border-radius: 16px; width: 90%; max-width: 600px; position: relative; box-shadow: 0 5px 25px rgba(0,0,0,0.1); animation: slideIn 0.4s; }
        .close-button { color: #aaa; position: absolute; top: 15px; right: 25px; font-size: 32px; font-weight: bold; cursor: pointer; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background-color: var(--bg-color); box-sizing: border-box; }
        #api-results { border:1px solid #eee; border-radius:8px; margin-top:5px; max-height: 250px; overflow-y: auto; }
        .hidden { display: none; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--primary-text); color: white; padding: 12px 25px; border-radius: 8px; z-index: 2000; opacity: 0; transition: opacity 0.5s, bottom 0.5s; }
        .toast.show { opacity: 1; bottom: 30px; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes slideIn { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
    </style>
</head>
<body>

    <div id="login-screen" style="text-align: center; padding-top: 20vh;">
        <header><h1>Benim Güzel Kütüphanem</h1></header>
        <button id="login-btn">Google ile Giriş Yap</button>
    </div>

    <div id="main-app" class="hidden">
        <header>
            <h1>Benim Güzel Kütüphanem</h1>
            <div class="user-profile" style="font-weight: 500;">
                <span id="user-display-name"></span>
                <button id="logout-btn" style="background:var(--pink-accent); color:var(--primary-text); margin-left:15px; font-size:0.8em; padding:8px 12px;">Çıkış Yap</button>
            </div>
        </header>
        <div class="container">
            <nav>
                <button class="nav-button active" id="show-library-btn">Kütüphanem</button>
                <button class="nav-button" id="show-wishlist-btn">İstek Listem</button>
            </nav>
            <main id="library-view">
                <section class="stats-panel" id="stats-panel-id"></section>
                <div class="controls-bar">
                    <div class="top-controls">
                        <button id="add-book-btn">Yeni Kitap Ekle</button>
                        <input type="text" id="search-input" placeholder="Kitap veya yazar ara...">
                    </div>
                    <div class="bottom-controls">
                        <select id="filter-status" style="flex:1;">
                            <option value="Tümü">Filtrele: Tümü</option><option value="Okunacak">Okunacak</option><option value="Okunuyor">Okunuyor</option><option value="Okundu">Okundu</option><option value="Ödünç Verildi">Ödünç Verildi</option>
                        </select>
                        <select id="sort-by" style="flex:1;">
                            <option value="title_asc">Sırala: Ada Göre (A-Z)</option>
                            <option value="author_asc">Sırala: Yazara Göre (A-Z)</option>
                            <option value="rating_desc">Sırala: Puana Göre (Yüksek)</option>
                            <option value="dateAdded_desc">Sırala: Eklenme Tarihi (Yeni)</option>
                        </select>
                        <div style="display:flex; gap:10px;">
                            <button id="import-btn">İçe Aktar</button>
                            <button id="export-btn">Dışa Aktar</button>
                            <input type="file" id="import-file" class="hidden" accept=".json">
                        </div>
                    </div>
                </div>
                <div class="list-container" id="book-list"></div>
            </main>
            <main id="wishlist-view" class="hidden">
                <div class="controls-bar"><button id="add-wish-btn">Yeni İstek Ekle</button></div>
                <div class="list-container" id="wish-list"></div>
            </main>
        </div>
        <div id="modal-container"></div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase ve Değişken Tanımlamaları ---
        const firebaseConfig = {
             apiKey: "AIzaSyASaHGgjR-zsQ50E9JmCcBnBq2KyXcltuE",
            authDomain: "benim-kutuphanem402.firebaseapp.com",
            projectId: "benim-kutuphanem402",
            storageBucket: "benim-kutuphanem402.appspot.com",
            messagingSenderId: "400988696330",
            appId: "1:400988696330:web:d9e2f0fa4301c2c8f714f3"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const FieldValue = firebase.firestore.FieldValue;

        let allBooks = [];
        let wishes = [];
        let currentUser = null;
        let unsubscribeBooks = null;
        let unsubscribeWishes = null;

        const ui = {
            loginScreen: document.getElementById('login-screen'), mainApp: document.getElementById('main-app'),
            loginBtn: document.getElementById('login-btn'), logoutBtn: document.getElementById('logout-btn'),
            userDisplayName: document.getElementById('user-display-name'), bookList: document.getElementById('book-list'),
            wishList: document.getElementById('wish-list'), searchInput: document.getElementById('search-input'),
            filterStatus: document.getElementById('filter-status'), sortBy: document.getElementById('sort-by'),
            libraryView: document.getElementById('library-view'), wishlistView: document.getElementById('wishlist-view'),
            nav: { library: document.getElementById('show-library-btn'), wishlist: document.getElementById('show-wishlist-btn') },
            modalContainer: document.getElementById('modal-container'), statsPanel: document.getElementById('stats-panel-id')
        };
        
        // --- Kimlik Doğrulama ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                ui.loginScreen.classList.add('hidden'); ui.mainApp.classList.remove('hidden');
                ui.userDisplayName.textContent = `Hoş geldin, ${user.displayName.split(' ')[0]}`;
                loadBooks();
                loadWishes();
            } else {
                currentUser = null;
                ui.loginScreen.classList.remove('hidden'); ui.mainApp.classList.add('hidden');
                if (unsubscribeBooks) unsubscribeBooks();
                if (unsubscribeWishes) unsubscribeWishes();
            }
        });
        ui.loginBtn.onclick = () => { const p = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(p).catch(e => console.error("Giriş Hatası:", e)); };
        ui.logoutBtn.onclick = () => auth.signOut();

        // --- Veri Yolları ---
        const getBooksCollection = () => db.collection('users').doc(currentUser.uid).collection('books');
        const getWishesCollection = () => db.collection('users').doc(currentUser.uid).collection('wishes');

        // --- Veri Yükleme ve Sıralama ---
        const loadBooks = () => {
            if (unsubscribeBooks) unsubscribeBooks(); // Önceki listener'ı durdur

            const [field, direction] = ui.sortBy.value.split('_');
            let query = getBooksCollection().orderBy(field, direction);
            
            // Gerçek zamanlı olarak tüm kitapları yükle
            unsubscribeBooks = query.onSnapshot(snapshot => {
                allBooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderBooks();
                renderStats();
            }, error => {
                console.error("Kitaplar yüklenemedi:", error);
                showToast("Kitaplar yüklenirken bir hata oluştu.", "error");
            });
        };
        
        const loadWishes = () => {
            if (unsubscribeWishes) unsubscribeWishes();
            unsubscribeWishes = getWishesCollection().orderBy('dateAdded', 'desc').onSnapshot(snapshot => {
                wishes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderWishes();
            });
        };

        const renderStats = () => {
            ui.statsPanel.innerHTML = `
                <div class="stat-item"><h3>${allBooks.length}</h3><p>Toplam Kitap</p></div>
                <div class="stat-item"><h3>${allBooks.filter(b => b.status === 'Okundu').length}</h3><p>Okunmuş</p></div>
                <div class="stat-item"><h3>${allBooks.filter(b => b.status === 'Okunuyor').length}</h3><p>Okunuyor</p></div>
                <div class="stat-item"><h3>${allBooks.filter(b => b.status === 'Ödünç Verildi').length}</h3><p>Ödünç Verilen</p></div>
                <div class="stat-item"><h3>${allBooks.filter(b => b.status === 'Okunacak').length}</h3><p>Okunacak</p></div>`;
        };
        
        // --- Arayüz Çizim (Render) Fonksiyonları ---
        const getStarRating = (r=0) => '★'.repeat(r) + '☆'.repeat(5 - r);
        const createBookCard = (book) => {
            const card = document.createElement('div');
            card.className = `book-card status-card-${(book.status || 'okunacak').toLowerCase().replace(/\s/g, '-')}`;
            const coverUrl = (book.coverUrl || '').replace('http://', 'https://');
            const placeholder = 'https://via.placeholder.com/100x150/F8F5F2/403D39?text=Kapak';
            card.innerHTML = `<div class="card-cover"><img src="${coverUrl || placeholder}" alt="${book.title}" loading="lazy"></div>
                              <div class="card-info"><h3>${book.title}</h3><p>${book.author}</p><p class="book-rating">${getStarRating(book.rating)}</p></div>`;
            card.onclick = () => renderDetailsModal(book);
            return card;
        };

        const renderBooks = () => {
            const searchTerm = ui.searchInput.value.toLowerCase();
            const currentFilter = ui.filterStatus.value;
            const filteredBooks = allBooks.filter(book => 
                (book.title.toLowerCase().includes(searchTerm) || book.author.toLowerCase().includes(searchTerm)) && 
                (currentFilter === 'Tümü' || book.status === currentFilter)
            );
            ui.bookList.innerHTML = '';
            filteredBooks.forEach(book => ui.bookList.appendChild(createBookCard(book)));
        };

        const renderWishes = () => {
            ui.wishList.innerHTML = '';
            wishes.forEach(wish => {
                const card = document.createElement('div');
                card.className = 'wish-card';
                card.innerHTML = `<div class="card-info"><h3>${wish.title}</h3><p>${wish.author || 'Yazar belirtilmemiş'}</p><div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap:wrap;"><button class="btn-edit">Düzenle</button><button class="btn-delete" style="background:var(--danger-color);">Sil</button><button class="btn-move">Kütüphaneye Taşı</button></div></div>`;
                card.querySelector('.btn-edit').onclick = (e) => { e.stopPropagation(); renderWishFormModal(wish); };
                card.querySelector('.btn-delete').onclick = (e) => { e.stopPropagation(); if(confirm('Bu isteği silmek istediğinize emin misiniz?')) getWishesCollection().doc(wish.id).delete().catch(err => showToast('İstek silinemedi.', 'error')); };
                card.querySelector('.btn-move').onclick = (e) => { e.stopPropagation(); handleMoveToLibrary(wish); };
                ui.wishList.appendChild(card);
            });
        };

        // --- Modal Yönetimi ---
        const openModal = (content) => {
            ui.modalContainer.innerHTML = `<div class="modal" style="display:block;"><div class="modal-content">${content}</div></div>`;
            const modal = ui.modalContainer.querySelector('.modal');
            modal.querySelector('.close-button')?.addEventListener('click', closeModal);
        };
        const closeModal = () => {
            const modal = ui.modalContainer.querySelector('.modal');
            if (modal) {
                modal.style.display = 'none';
                setTimeout(() => { ui.modalContainer.innerHTML = ''; }, 300);
            }
        };
        window.onclick = e => { if (e.target.classList.contains('modal')) closeModal(); };

        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = 'toast';
            if(type === 'error') toast.style.backgroundColor = 'var(--danger-color)';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => document.body.removeChild(toast), 500); }, 3000); }, 100);
        };
        
        // --- Form ve CRUD Fonksiyonları ---
        const renderBookFormModal = (book = {}) => {
            const isEditing = !!book.id;
            const title = isEditing ? 'Kitabı Düzenle' : 'Yeni Kitap Ekle';
            const content = `<span class="close-button" aria-label="Kapat">&times;</span><h2>${title}</h2>
                <form id="book-form" data-moved-from-wish-id="${book.movedFromWishId || ''}">
                    <div class="form-group"><label for="title">Kitap Adı</label><input type="text" id="title" value="${book.title || ''}" required><div id="api-results"></div></div>
                    <div class="form-group"><label for="author">Yazar</label><input type="text" id="author" value="${book.author || ''}" required></div>
                    <div class="form-group"><label for="publisher">Yayınevi</label><input type="text" id="publisher" value="${book.publisher || ''}"></div>
                    <div class="form-group"><label for="cover-url">Kapak Fotoğrafı URL</label><input type="text" id="cover-url" value="${book.coverUrl || ''}"><label for="cover-file-input" style="display:inline-block; padding:8px 15px; background-color:var(--pink-accent); color:var(--primary-text); border-radius:8px; cursor:pointer; font-size:0.9em; margin-top:8px;">Veya Yükle</label><input type="file" id="cover-file-input" class="hidden" accept="image/*"><img id="cover-preview" class="${book.coverUrl ? '' : 'hidden'}" src="${book.coverUrl || ''}" alt="Önizleme" style="max-width:100px; max-height:150px; margin-top:10px; border-radius:8px; border:1px solid #ddd;"></div>
                    <div class="form-group"><label for="status">Durum</label><select id="status"></select></div>
                    <div class="form-group hidden" id="date-fields"></div>
                    <div class="form-group"><label for="rating">Puan (0-5)</label><input type="number" id="rating" min="0" max="5" step="1" value="${book.rating || 0}"></div>
                    <button type="submit">Kaydet</button>
                </form>`;
            openModal(content);
            const form = document.getElementById('book-form');
            const statusSelect = form.querySelector('#status');
            ['Okunacak', 'Okunuyor', 'Okundu'].forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; if(book.status===s) o.selected=true; statusSelect.appendChild(o); });
            const updateDateFields = () => {
                const fieldsDiv = form.querySelector('#date-fields');
                fieldsDiv.innerHTML = '';
                if (statusSelect.value === 'Okunuyor') fieldsDiv.innerHTML = `<label for="start-date">Başlama Tarihi</label><input type="date" id="start-date" value="${book.startDate || ''}">`;
                else if (statusSelect.value === 'Okundu') fieldsDiv.innerHTML = `<label for="finish-date">Bitirme Tarihi</label><input type="date" id="finish-date" value="${book.finishDate || ''}">`;
                fieldsDiv.classList.toggle('hidden', statusSelect.value === 'Okunacak' || !statusSelect.value);
            };
            statusSelect.onchange = updateDateFields; updateDateFields();
            form.onsubmit = (e) => handleBookFormSubmit(e, book);
            let searchTimeout;
            form.querySelector('#title').onkeyup = (e) => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => searchGoogleBooks(e.target.value), 500); };
            form.querySelector('#cover-file-input').onchange = (e) => handleCoverFileUpload(e, form);
            form.querySelector('#cover-url').addEventListener('input', e => {
                const preview = form.querySelector('#cover-preview');
                preview.src = e.target.value.trim().replace('http://', 'https://');
                preview.classList.toggle('hidden', !e.target.value.trim());
            });
        };

        const handleBookFormSubmit = async (e, existingBook) => {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true; submitButton.textContent = "Kaydediliyor...";
            
            const newValues = {
                title: form.title.value, author: form.author.value, publisher: form.publisher.value,
                coverUrl: form['cover-url'].value, status: form.status.value, rating: parseInt(form.rating.value) || 0,
                startDate: form['start-date']?.value || '', finishDate: form['finish-date']?.value || ''
            };
            const bookData = existingBook.id ? { ...existingBook, ...newValues } : { ...newValues };

            try {
                if (existingBook.id) {
                    await getBooksCollection().doc(existingBook.id).update(bookData);
                } else {
                    await getBooksCollection().add({ ...bookData, notes: [], dateAdded: new Date() });
                    const movedFromWishId = form.dataset.movedFromWishId;
                    if (movedFromWishId) await getWishesCollection().doc(movedFromWishId).delete();
                }
                closeModal();
                showToast(existingBook.id ? 'Kitap güncellendi.' : 'Kitap eklendi.');
            } catch (error) { console.error("Kitap kaydetme hatası: ", error); showToast('Kitap kaydedilemedi.','error'); }
            finally { submitButton.disabled = false; submitButton.textContent = "Kaydet"; }
        };
        
        const renderDetailsModal = (book) => {
            const statusText = book.status === 'Ödünç Verildi' ? `${book.status} (${book.lentTo || ''})` : book.status;
            const content = `<span class="close-button" aria-label="Kapat">&times;</span>
                <div style="display:flex; gap:20px; flex-wrap:wrap;">
                    <img src="${(book.coverUrl || '').replace('http://', 'https://') || 'https://via.placeholder.com/150x220'}" alt="${book.title}" style="width:150px; height:220px; object-fit:cover; border-radius:8px;">
                    <div style="flex:1;">
                        <h2>${book.title}</h2>
                        <p><strong>Yazar:</strong> ${book.author}</p><p><strong>Puan:</strong> <span class="book-rating">${getStarRating(book.rating)}</span></p>
                        <p><strong>Durum:</strong> ${statusText}</p>
                        ${book.startDate ? `<p><strong>Başlama:</strong> ${book.startDate}</p>` : ''}
                        ${book.finishDate ? `<p><strong>Bitirme:</strong> ${book.finishDate}</p>` : ''}
                    </div>
                </div>
                <div id="notes-section" style="margin-top: 20px;"></div>
                <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; display: flex; gap: 10px; flex-wrap:wrap;">
                    <button class="btn-edit">Düzenle</button>
                    ${book.status !== 'Ödünç Verildi' ? '<button class="btn-lend">Ödünç Ver</button>' : '<button class="btn-return">Geri Al</button>'}
                    <button class="btn-delete" style="background:var(--danger-color);">Sil</button>
                </div>`;
            openModal(content);
            const modal = ui.modalContainer.querySelector('.modal');
            modal.querySelector('.btn-edit').onclick = () => renderBookFormModal(book);
            modal.querySelector('.btn-delete').onclick = async () => { if(confirm('Bu kitabı silmek istediğinize emin misiniz?')){ closeModal(); await getBooksCollection().doc(book.id).delete(); showToast('Kitap silindi.'); }};
            const lendBtn = modal.querySelector('.btn-lend');
            if (lendBtn) lendBtn.onclick = () => handleLendBook(book);
            const returnBtn = modal.querySelector('.btn-return');
            if (returnBtn) returnBtn.onclick = () => handleReturnBook(book);
            renderNotes(book);
        };
        
        const handleLendBook = (book) => {
            const content = `<span class="close-button" aria-label="Kapat">&times;</span><h2>Kitabı Ödünç Ver</h2>
                <form id="lend-form"><div class="form-group"><label for="borrower">Kime Ödünç Verildi?</label><input type="text" id="borrower" required></div><button type="submit">Onayla</button></form>`;
            openModal(content);
            ui.modalContainer.querySelector('#lend-form').onsubmit = async (e) => {
                e.preventDefault();
                await getBooksCollection().doc(book.id).update({ status: 'Ödünç Verildi', lentTo: e.target.borrower.value, lentDate: new Date().toISOString().slice(0,10) });
                closeModal(); showToast('Kitap ödünç verildi.');
            };
        };

        const handleReturnBook = async (book) => {
            await getBooksCollection().doc(book.id).update({ status: 'Okunacak', lentTo: FieldValue.delete(), lentDate: FieldValue.delete() });
            closeModal(); showToast('Kitap geri alındı.');
        };

        const renderNotes = (book) => {
            const notesSection = document.getElementById('notes-section');
            notesSection.innerHTML = `<h3>Kitap Notları</h3><div id="notes-list"></div>
                <form id="note-form" style="margin-top:15px;"><div class="form-group"><textarea id="new-note-text" placeholder="Yeni bir not ekle..." rows="3" required></textarea><button type="submit" style="width:auto; float:right; margin-top:10px;">Not Ekle</button></div></form>`;
            const notesListDiv = document.getElementById('notes-list');
            if (book.notes && book.notes.length > 0) {
                book.notes.sort((a,b) => b.id - a.id).forEach(note => {
                    const noteDiv = document.createElement('div');
                    noteDiv.style.background = '#f9f9f9'; noteDiv.style.padding = '10px'; noteDiv.style.borderRadius = '8px'; noteDiv.style.marginBottom = '10px';
                    noteDiv.innerHTML = `<p style="margin:0;">${note.text.replace(/\n/g, '<br>')}</p><small style="color:var(--secondary-text)">${new Date(note.id).toLocaleDateString('tr-TR')}</small>`;
                    notesListDiv.appendChild(noteDiv);
                });
            } else {
                notesListDiv.innerHTML = '<p style="color:var(--secondary-text); text-align:center;">Henüz not eklenmemiş.</p>';
            }
            document.getElementById('note-form').onsubmit = (e) => { e.preventDefault(); handleAddOrUpdateNote(book, e.target['new-note-text'].value); };
        };

        const handleAddOrUpdateNote = async (book, text) => {
            const newNote = { id: Date.now(), text: text.trim() };
            await getBooksCollection().doc(book.id).update({ notes: FieldValue.arrayUnion(newNote) });
        };

        const renderWishFormModal = (wish={}) => {
            const isEditing = !!wish.id;
            const content = `<span class="close-button" aria-label="Kapat">&times;</span><h2>${isEditing ? 'İsteği Düzenle' : 'Yeni İstek Ekle'}</h2>
                <form id="wish-form"><div class="form-group"><label for="wish-title">Kitap Adı</label><input type="text" id="wish-title" value="${wish.title || ''}" required></div><div class="form-group"><label for="wish-author">Yazar</label><input type="text" id="wish-author" value="${wish.author || ''}"></div><button type="submit">Kaydet</button></form>`;
            openModal(content);
            ui.modalContainer.querySelector('#wish-form').onsubmit = async (e) => {
                e.preventDefault();
                const wishData = { title: e.target['wish-title'].value, author: e.target['wish-author'].value };
                try {
                    if (isEditing) await getWishesCollection().doc(wish.id).update(wishData);
                    else await getWishesCollection().add({ ...wishData, dateAdded: new Date() });
                    closeModal(); showToast(isEditing ? 'İstek güncellendi.' : 'İstek eklendi.');
                } catch(err) { showToast('İstek kaydedilemedi.', 'error'); }
            };
        };

        const handleMoveToLibrary = (wish) => { renderBookFormModal({ title: wish.title, author: wish.author, movedFromWishId: wish.id }); };
        
        // --- API, Dosya Yükleme, Import/Export ---
        const handleCoverFileUpload = (e, form) => {
             const file = e.target.files[0]; if (!file) return;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true; submitButton.textContent = "Kapak Yükleniyor...";
            const uploadTask = storage.ref(`covers/${currentUser.uid}/${Date.now()}_${file.name}`).put(file);
            uploadTask.on('state_changed', null, 
                (error) => { console.error(error); showToast("Kapak yüklenemedi", "error"); submitButton.disabled = false; submitButton.textContent = "Kaydet"; },
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((url) => {
                        form.querySelector('#cover-url').value = url;
                        form.querySelector('#cover-preview').src = url;
                        form.querySelector('#cover-preview').classList.remove('hidden');
                        submitButton.disabled = false; submitButton.textContent = "Kaydet";
                    });
                }
            );
        };
        const searchGoogleBooks = async (query) => {
            const apiResultsDiv = document.getElementById('api-results');
            if (!apiResultsDiv || query.length < 3) { if(apiResultsDiv) apiResultsDiv.innerHTML = ''; return; }
            apiResultsDiv.innerHTML = '<p style="padding:10px;">Aranıyor...</p>';
            try {
                const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=5`);
                const data = await res.json();
                apiResultsDiv.innerHTML = '';
                if (!data.items) return;
                data.items.forEach(item => {
                    const info = item.volumeInfo;
                    if(!info.title || !info.authors) return;
                    const div = document.createElement('div');
                    div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.padding = '10px'; div.style.cursor = 'pointer';
                    div.onmouseover = () => div.style.backgroundColor = '#f0f0f0';
                    div.onmouseout = () => div.style.backgroundColor = 'transparent';
                    let thumb = (info.imageLinks?.thumbnail || '').replace('http://', 'https://');
                    div.innerHTML = `<img src="${thumb || 'https://via.placeholder.com/40x60'}" alt="" style="width:40px; height:60px; object-fit:cover; margin-right:10px;"><div class="api-item-info"><p style="margin:0; font-weight:bold;">${info.title}</p><p style="margin:0; font-size:0.9em;">${info.authors.join(', ')}</p></div>`;
                    div.onclick = () => {
                        const form = document.getElementById('book-form');
                        form.title.value = info.title || ''; form.author.value = info.authors?.join(', ') || ''; form.publisher.value = info.publisher || '';
                        form.querySelector('#cover-url').value = thumb; form.querySelector('#cover-preview').src = thumb;
                        form.querySelector('#cover-preview').classList.remove('hidden');
                        apiResultsDiv.innerHTML = '';
                    };
                    apiResultsDiv.appendChild(div);
                });
            } catch (error) { console.error("API Hatası:", error); apiResultsDiv.innerHTML = '<p style="color:red; padding:10px;">API hatası.</p>';}
        };
        const handleExport = () => { showToast('Veriler hazırlanıyor...'); getBooksCollection().get().then(snap => { const data = { books: snap.docs.map(d=>d.data()), wishes }; const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `kutuphanem_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url); }); };
        const handleImport = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.books && confirm('MEVCUT KÜTÜPHANE BU DOSYAYLA DEĞİŞTİRİLECEK! Bu işlem geri alınamaz. Onaylıyor musunuz?')) {
                        showToast("Veriler içe aktarılıyor, lütfen bekleyin...", 'info');
                        const existingDocs = await getBooksCollection().get();
                        const deleteBatch = db.batch();
                        existingDocs.docs.forEach(doc => deleteBatch.delete(doc.ref));
                        await deleteBatch.commit();
                        for (let i = 0; i < data.books.length; i += 499) {
                            const batch = db.batch();
                            data.books.slice(i, i + 499).forEach(book => batch.set(getBooksCollection().doc(), book));
                            await batch.commit();
                        }
                        showToast("Kütüphane başarıyla güncellendi!", "success");
                    }
                } catch (error) { console.error("Import Error:", error); showToast('Hata: Dosya okunamadı veya format geçersiz.', 'error'); }
            };
            reader.readAsText(file); e.target.value = null;
        };
        
        // --- Event Listeners ---
        ui.searchInput.addEventListener('input', renderBooks);
        ui.filterStatus.addEventListener('change', renderBooks);
        ui.sortBy.addEventListener('change', loadBooks);
        document.getElementById('add-book-btn').onclick = () => renderBookFormModal();
        document.getElementById('add-wish-btn').onclick = () => renderWishFormModal();
        document.getElementById('export-btn').onclick = handleExport;
        document.getElementById('import-btn').onclick = () => document.getElementById('import-file').click();
        document.getElementById('import-file').onchange = handleImport;
        ui.nav.library.onclick = () => { ui.libraryView.classList.remove('hidden'); ui.wishlistView.classList.add('hidden'); ui.nav.library.classList.add('active'); ui.nav.wishlist.classList.remove('active'); };
        ui.nav.wishlist.onclick = () => { ui.libraryView.classList.add('hidden'); ui.wishlistView.classList.remove('hidden'); ui.nav.library.classList.remove('active'); ui.nav.wishlist.classList.add('active'); };
    });
    </script>
</body>
</html>
